<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Roguelike tutorial for Common Lisp - Part 2 - Generic entity and map - nick forrer</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Roguelike tutorial for Common Lisp - Part 2 - Generic entity and map" />
<meta property="og:description" content="This tutorial series is based on the Python Roguelike Tutorial. This will be covering Part 2 of that tutorial.
It&rsquo;s time to start thinking about how we want to structure our entities, and what the map will look like. We will be creating a generic entity class that all entities in the game will use, and introduce the concept of how the map will be structured. We&rsquo;ll be using classes and generic methods provided with CLOS here." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nwforrer.github.io/posts/roguelike-tutorial-part2/" />
<meta property="article:published_time" content="2019-06-27T21:53:00-04:00"/>
<meta property="article:modified_time" content="2019-06-27T21:53:00-04:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Roguelike tutorial for Common Lisp - Part 2 - Generic entity and map"/>
<meta name="twitter:description" content="This tutorial series is based on the Python Roguelike Tutorial. This will be covering Part 2 of that tutorial.
It&rsquo;s time to start thinking about how we want to structure our entities, and what the map will look like. We will be creating a generic entity class that all entities in the game will use, and introduce the concept of how the map will be structured. We&rsquo;ll be using classes and generic methods provided with CLOS here."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://nwforrer.github.io/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://nwforrer.github.io/css/main.css" /><script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script><script src="https://nwforrer.github.io/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title">nick forrer</h1>
	<div class="site-description"><h2>Game development and Lisp related posts</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/nwforrer" title="Github"><i data-feather="github"></i></a><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/categories/roguelike-tutorial">Roguelike Tutorials</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Roguelike tutorial for Common Lisp - Part 2 - Generic entity and map</h1>
			<div class="meta">Posted at &mdash; Jun 27, 2019</div>
		</div>

		<div class="markdown">
			

<p>This tutorial series is based on the <a href="http://rogueliketutorials.com">Python Roguelike Tutorial</a>. This will be
covering <a href="http://rogueliketutorials.com/tutorials/tcod/part-2/">Part 2</a> of that tutorial.</p>

<p>It&rsquo;s time to start thinking about how we want to structure our entities, and
what the map will look like. We will be creating a generic entity class that all
entities in the game will use, and introduce the concept of how the map will be
structured. We&rsquo;ll be using classes and generic methods provided with CLOS here.
If you&rsquo;re unfamiliar with CLOS, there is a good overview in <a href="https://lispcookbook.github.io/cl-cookbook/clos.html">The Common Lisp Cookbook</a>.</p>

<h2 id="generic-entity">Generic entity</h2>

<p>The first thing we&rsquo;ll be doing is creating a class to represent entities in the
game, storing it&rsquo;s position, color, and character to render.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">defclass</span> <span style="color:#b8860b">entity</span> ()
  ((<span style="color:#b8860b">x</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/x</span>)
   (<span style="color:#b8860b">y</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/y</span>)
   (<span style="color:#b8860b">char</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:char</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/char</span>)
   (<span style="color:#b8860b">color</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:color</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/color</span>)))</code></pre></div>
<p>Next we can create some methods on that class to handle drawing and moving the
entity.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">defmethod</span> <span style="color:#b8860b">move</span> ((<span style="color:#b8860b">e</span> <span style="color:#b8860b">entity</span>) <span style="color:#b8860b">dx</span> <span style="color:#b8860b">dy</span>)
  (<span style="color:#b8860b">incf</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">e</span>) <span style="color:#b8860b">dx</span>)
  (<span style="color:#b8860b">incf</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">e</span>) <span style="color:#b8860b">dy</span>))

(<span style="color:#b8860b">defmethod</span> <span style="color:#b8860b">draw</span> ((<span style="color:#b8860b">e</span> <span style="color:#b8860b">entity</span>))
  (<span style="color:#b8860b">with-slots</span> (<span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">char</span> <span style="color:#b8860b">color</span>) <span style="color:#b8860b">e</span>
    (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">blt:color</span>) <span style="color:#b8860b">color</span>
          (<span style="color:#b8860b">blt:cell-char</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) <span style="color:#b8860b">char</span>)))</code></pre></div>
<p>We&rsquo;ll rename our old draw function to render-all, and from there call the entities draw
method for each entity.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">defun</span> <span style="color:#b8860b">render-all</span> (<span style="color:#b8860b">entities</span>)
  (<span style="color:#b8860b">blt:clear</span>)
  (<span style="color:#b8860b">mapc</span> <span style="color:#00a000">#&#39;</span><span style="color:#b8860b">draw</span> <span style="color:#b8860b">entities</span>)
  (<span style="color:#b8860b">blt:refresh</span>))</code></pre></div>
<p>We&rsquo;re just mapping the draw method call over the list of all entities passed
into the function.</p>

<p>Now we actually need to create some entities. Update the main function as
follows:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">defun</span> <span style="color:#b8860b">main</span>()
  (<span style="color:#b8860b">blt:with-terminal</span>
    (<span style="color:#b8860b">config</span>)
    (<span style="color:#b8860b">loop</span> <span style="color:#b8860b">:with</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">=</span> (<span style="color:#b8860b">make-instance</span> <span style="color:#b8860b">&#39;entity</span>
                                        <span style="color:#b8860b">:x</span> (<span style="color:#b8860b">/</span> *screen-width* <span style="color:#666">2</span>)
                                        <span style="color:#b8860b">:y</span> (<span style="color:#b8860b">/</span> *screen-height* <span style="color:#666">2</span>)
                                        <span style="color:#b8860b">:char</span> <span style="color:#b44">#\@</span>
                                        <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:white</span>))
          <span style="color:#b8860b">:and</span> <span style="color:#b8860b">npc</span> <span style="color:#b8860b">=</span> (<span style="color:#b8860b">make-instance</span> <span style="color:#b8860b">&#39;entity</span>
                                    <span style="color:#b8860b">:x</span> (<span style="color:#b8860b">-</span> (<span style="color:#b8860b">/</span> *screen-width* <span style="color:#666">2</span>) <span style="color:#666">5</span>)
                                    <span style="color:#b8860b">:y</span> (<span style="color:#b8860b">/</span> *screen-height* <span style="color:#666">2</span>)
                                    <span style="color:#b8860b">:char</span> <span style="color:#b44">#\@</span>
                                    <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:yellow</span>))
          <span style="color:#b8860b">:with</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">=</span> (<span style="color:#b8860b">list</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">npc</span>)
          <span style="color:#b8860b">:do</span>
             (<span style="color:#b8860b">render-all</span> <span style="color:#b8860b">entities</span>)
             (<span style="color:#b8860b">let*</span> ((<span style="color:#b8860b">action</span> (<span style="color:#b8860b">handle-keys</span>))
                    (<span style="color:#b8860b">move</span> (<span style="color:#b8860b">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:move</span>))
                    (<span style="color:#b8860b">exit</span> (<span style="color:#b8860b">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:quit</span>)))
               (<span style="color:#b8860b">when</span> <span style="color:#b8860b">exit</span>
                 (<span style="color:#b8860b">return</span>))
               (<span style="color:#b8860b">when</span> <span style="color:#b8860b">move</span>
                 (<span style="color:#b8860b">move</span> <span style="color:#b8860b">player</span> (<span style="color:#b8860b">car</span> <span style="color:#b8860b">move</span>) (<span style="color:#b8860b">cdr</span> <span style="color:#b8860b">move</span>)))))))</code></pre></div>
<p>Here we removed the player-x and player-y variables, and instead create a player
entity. We have also added an npc entity to show how we can use the entity class
for more than just the player. We add those two entities to an entities list,
which gets passed to the render-all function. We also call the new move method
on the player entity when a move action is requested.</p>

<p>If you run the game now, it should look like the following:
<img src="/cl-rltut/generic-entity-class.png" alt="" /></p>

<p>The NPC should look like a yellow @ symbol, and player movement should work like it
did before.</p>

<h2 id="creating-the-map">Creating the map</h2>

<p>Now that we can create and render entities, we should create a map for them to
move around in. We&rsquo;re not going to procedurally generate the map yet (that will
be in the next tutorial), but we&rsquo;ll create the structure needed to render the
map.</p>

<p>Before we do, let&rsquo;s create a new file to store the map related code, as it can
become pretty large once we&rsquo;re generating it. Create a file named
&ldquo;game-map.lisp&rdquo; in the root of your project, and declare that it&rsquo;s in the same
package by placing this at the top of the file:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">in-package</span> <span style="color:#b8860b">#:cl-rltut</span>)</code></pre></div>
<p>You also need to update the ASDF file to include the new file in your system:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">asdf:defsystem</span> <span style="color:#b8860b">#:cl-rltut</span>
  <span style="color:#b8860b">:description</span> <span style="color:#b44">&#34;Describe cl-rltut here&#34;</span>
  <span style="color:#b8860b">:author</span> <span style="color:#b44">&#34;Nick Forrer&#34;</span>
  <span style="color:#b8860b">:license</span> <span style="color:#b44">&#34;MIT&#34;</span>
  <span style="color:#b8860b">:version</span> <span style="color:#b44">&#34;0.0.1&#34;</span>
  <span style="color:#b8860b">:serial</span> <span style="color:#800">t</span>
  <span style="color:#b8860b">:depends-on</span> (<span style="color:#b8860b">#:cl-blt</span>)
  <span style="color:#b8860b">:components</span> ((<span style="color:#b8860b">:file</span> <span style="color:#b44">&#34;package&#34;</span>)
               (<span style="color:#b8860b">:file</span> <span style="color:#b44">&#34;cl-rltut&#34;</span>)
               (<span style="color:#b8860b">:file</span> <span style="color:#b44">&#34;game-map&#34;</span>)))</code></pre></div>
<p>In the &ldquo;game-map.lisp&rdquo; file, create a new tile class.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">defclass</span> <span style="color:#b8860b">tile</span> ()
  ((<span style="color:#b8860b">blocked</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:blocked</span>
            <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">tile/blocked</span>
            <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)
   (<span style="color:#b8860b">block-sight</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:block-sight</span>
                <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">tile/block-sight</span>
                <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)))

(<span style="color:#b8860b">defmethod</span> <span style="color:#b8860b">initialize-instance</span> <span style="color:#b8860b">:after</span> ((<span style="color:#b8860b">tile</span> <span style="color:#b8860b">tile</span>) <span style="color:#b8860b">&amp;rest</span> <span style="color:#b8860b">initargs</span>)
  (<span style="color:#b8860b">declare</span> (<span style="color:#b8860b">ignore</span> <span style="color:#b8860b">initargs</span>))
  (<span style="color:#b8860b">with-slots</span> (<span style="color:#b8860b">blocked</span> <span style="color:#b8860b">block-sight</span>) <span style="color:#b8860b">tile</span>
    (<span style="color:#b8860b">if</span> (<span style="color:#b8860b">null</span> <span style="color:#b8860b">block-sight</span>)
        (<span style="color:#b8860b">setf</span> <span style="color:#b8860b">block-sight</span> <span style="color:#b8860b">blocked</span>))))</code></pre></div>
<p>The blocked slot will indicate whether this tile will block movement, such as if
it represents a wall. The block-sight slot will indicate if this tile will block
an entities vision. These are separate so that we can support things like lava
tiles, where we don&rsquo;t want an entity to walk through it, but they can see past
it. We will implement field-of-vision later, but that will determine which tiles
the player can see at a given time.
We&rsquo;ve also defined an after method for initialize-instance for the tile class.
This will be called after a make-instance is called for the class, and the slots
are initialized. Here, we want to make sure the block-sight slot is set to true
if blocked is also true.</p>

<p>Now lets create a game-map class, which will hold a 2D array of tiles to make up
our map.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">defclass</span> <span style="color:#b8860b">game-map</span> ()
  ((<span style="color:#b8860b">width</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:w</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">game-map/w</span>)
   (<span style="color:#b8860b">height</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:h</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">game-map/h</span>)
   (<span style="color:#b8860b">tiles</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">game-map/tiles</span>)))

(<span style="color:#b8860b">defmethod</span> <span style="color:#b8860b">initialize-instance</span> <span style="color:#b8860b">:after</span> ((<span style="color:#b8860b">map</span> <span style="color:#b8860b">game-map</span>) <span style="color:#b8860b">&amp;rest</span> <span style="color:#b8860b">initargs</span>)
  (<span style="color:#b8860b">declare</span> (<span style="color:#b8860b">ignore</span> <span style="color:#b8860b">initargs</span>))
  (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#b8860b">map</span>) (<span style="color:#b8860b">make-array</span> (<span style="color:#b8860b">list</span> (<span style="color:#b8860b">game-map/w</span> <span style="color:#b8860b">map</span>) (<span style="color:#b8860b">game-map/h</span> <span style="color:#b8860b">map</span>)))))</code></pre></div>
<p>We also define an initialize-instance method for game-map. This initializes the
tiles slot to an array with WxH dimensions.</p>

<p>Next create a function to initialize the tiles in the array.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">defun</span> <span style="color:#b8860b">initialize-tiles</span> ((<span style="color:#b8860b">map</span> <span style="color:#b8860b">game-map</span>))
  (<span style="color:#b8860b">dotimes</span> (<span style="color:#b8860b">y</span> (<span style="color:#b8860b">game-map/h</span> <span style="color:#b8860b">map</span>))
    (<span style="color:#b8860b">dotimes</span> (<span style="color:#b8860b">x</span> (<span style="color:#b8860b">game-map/w</span> <span style="color:#b8860b">map</span>))
      (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#b8860b">map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) (<span style="color:#b8860b">make-instance</span> <span style="color:#b8860b">&#39;tile</span>))))

  (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">tile/blocked</span> (<span style="color:#b8860b">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#b8860b">map</span>) <span style="color:#666">30</span> <span style="color:#666">22</span>)) <span style="color:#800">t</span>)
  (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">tile/block-sight</span> (<span style="color:#b8860b">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#b8860b">map</span>) <span style="color:#666">30</span> <span style="color:#666">22</span>)) <span style="color:#800">t</span>)
  (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">tile/blocked</span> (<span style="color:#b8860b">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#b8860b">map</span>) <span style="color:#666">31</span> <span style="color:#666">22</span>)) <span style="color:#800">t</span>)
  (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">tile/block-sight</span> (<span style="color:#b8860b">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#b8860b">map</span>) <span style="color:#666">31</span> <span style="color:#666">22</span>)) <span style="color:#800">t</span>)
  (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">tile/blocked</span> (<span style="color:#b8860b">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#b8860b">map</span>) <span style="color:#666">32</span> <span style="color:#666">22</span>)) <span style="color:#800">t</span>)
  (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">tile/block-sight</span> (<span style="color:#b8860b">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#b8860b">map</span>) <span style="color:#666">32</span> <span style="color:#666">22</span>)) <span style="color:#800">t</span>))</code></pre></div>
<p>This loops through all the tiles in the map, and initializes them to a new
instance of the tile class. This will create all the tiles with blocked and
block-sight set to nil. We then set 3 of the tiles to have blocked and
block-sight set to true so we can test it.</p>

<p>We now have a map created, but we can&rsquo;t see it yet. Back in the &ldquo;cl-rltut.lisp&rdquo;
file, update the render-all function to take the map as a parameter and render
all it&rsquo;s tiles.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">defparameter</span> *color-map* (<span style="color:#b8860b">list</span> <span style="color:#b8860b">:dark-wall</span> (<span style="color:#b8860b">blt:rgba</span> <span style="color:#666">0</span> <span style="color:#666">0</span> <span style="color:#666">100</span>)
                                <span style="color:#b8860b">:dark-ground</span> (<span style="color:#b8860b">blt:rgba</span> <span style="color:#666">50</span> <span style="color:#666">50</span> <span style="color:#666">150</span>)))

(<span style="color:#b8860b">defun</span> <span style="color:#b8860b">render-all</span> (<span style="color:#b8860b">entities</span> <span style="color:#b8860b">map</span>)
  (<span style="color:#b8860b">blt:clear</span>)
  (<span style="color:#b8860b">dotimes</span> (<span style="color:#b8860b">y</span> (<span style="color:#b8860b">game-map/h</span> <span style="color:#b8860b">map</span>))
    (<span style="color:#b8860b">dotimes</span> (<span style="color:#b8860b">x</span> (<span style="color:#b8860b">game-map/w</span> <span style="color:#b8860b">map</span>))
      (<span style="color:#b8860b">let*</span> ((<span style="color:#b8860b">tile</span> (<span style="color:#b8860b">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#b8860b">map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>))
             (<span style="color:#b8860b">wall</span> (<span style="color:#b8860b">tile/blocked</span> <span style="color:#b8860b">tile</span>)))
        (<span style="color:#b8860b">if</span> <span style="color:#b8860b">wall</span>
            (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#b8860b">getf</span> *color-map* <span style="color:#b8860b">:dark-wall</span>))
            (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#b8860b">getf</span> *color-map* <span style="color:#b8860b">:dark-ground</span>))))
      (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">blt:cell-char</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) <span style="color:#b44">#\Space</span>)))

  (<span style="color:#b8860b">mapc</span> <span style="color:#00a000">#&#39;</span><span style="color:#b8860b">draw</span> <span style="color:#b8860b">entities</span>)

  (<span style="color:#b8860b">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#b8860b">blt:black</span>))
  (<span style="color:#b8860b">blt:refresh</span>))</code></pre></div>
<p>We first declare a color-map global variable as a property list to hold a
mapping of keys (like &ldquo;dark-wall&rdquo;) to their BearLibTerminal color value. This
just makes it easier to reference colors, and easy to update them later if we
wanted to. Then, in the render-all method, we loop over all of the tiles in the
map. We check if the blocked slot is true, and if so, set blt:background-color
to dark-wall. Whenever you set the background-color, all subsequent draw calls
will use it as the background in the cell you draw to. If the tile is not
blocked, we set background-color to dark-ground. We then draw an empty space at
the tiles cell, which will just populate the background of the cell.
After the entire map and all entities are drawn, we reset the background-color
to black.</p>

<p>Now in the main function, lets create a map instance and pass it to the
render-all function to actually see it displayed.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">defparameter</span> *map-width* <span style="color:#666">80</span>)
(<span style="color:#b8860b">defparameter</span> *map-height* <span style="color:#666">45</span>)

(<span style="color:#b8860b">defparameter</span> *map* <span style="color:#800">nil</span>)

(<span style="color:#b8860b">defun</span> <span style="color:#b8860b">main</span> ()
  (<span style="color:#b8860b">blt:with-terminal</span>
    (<span style="color:#b8860b">config</span>)
    (<span style="color:#b8860b">setf</span> *map* (<span style="color:#b8860b">make-instance</span> <span style="color:#b8860b">&#39;game-map</span> <span style="color:#b8860b">:w</span> *map-width* <span style="color:#b8860b">:h</span> *map-height*))
    (<span style="color:#b8860b">initialize-tiles</span> *map*)
    (<span style="color:#b8860b">loop</span> <span style="color:#b8860b">:with</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">=</span> (<span style="color:#b8860b">make-instance</span> <span style="color:#b8860b">&#39;entity</span>
                                        <span style="color:#b8860b">:x</span> (<span style="color:#b8860b">/</span> *screen-width* <span style="color:#666">2</span>)
                                        <span style="color:#b8860b">:y</span> (<span style="color:#b8860b">/</span> *screen-height* <span style="color:#666">2</span>)
                                        <span style="color:#b8860b">:char</span> <span style="color:#b44">#\@</span>
                                        <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:white</span>))
          <span style="color:#b8860b">:and</span> <span style="color:#b8860b">npc</span> <span style="color:#b8860b">=</span> (<span style="color:#b8860b">make-instance</span> <span style="color:#b8860b">&#39;entity</span>
                                    <span style="color:#b8860b">:x</span> (<span style="color:#b8860b">-</span> (<span style="color:#b8860b">/</span> *screen-width* <span style="color:#666">2</span>) <span style="color:#666">5</span>)
                                    <span style="color:#b8860b">:y</span> (<span style="color:#b8860b">/</span> *screen-height* <span style="color:#666">2</span>)
                                    <span style="color:#b8860b">:char</span> <span style="color:#b44">#\@</span>
                                    <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:yellow</span>))
          <span style="color:#b8860b">:with</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">=</span> (<span style="color:#b8860b">list</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">npc</span>)
          <span style="color:#b8860b">:do</span>
             (<span style="color:#b8860b">render-all</span> <span style="color:#b8860b">entities</span> *map*)
             (<span style="color:#b8860b">let*</span> ((<span style="color:#b8860b">action</span> (<span style="color:#b8860b">handle-keys</span>))
                    (<span style="color:#b8860b">move</span> (<span style="color:#b8860b">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:move</span>))
                    (<span style="color:#b8860b">exit</span> (<span style="color:#b8860b">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:quit</span>)))
               (<span style="color:#b8860b">when</span> <span style="color:#b8860b">exit</span>
                 (<span style="color:#b8860b">return</span>))
               (<span style="color:#b8860b">when</span> <span style="color:#b8860b">move</span>
                 (<span style="color:#b8860b">move</span> <span style="color:#b8860b">player</span> (<span style="color:#b8860b">car</span> <span style="color:#b8860b">move</span>) (<span style="color:#b8860b">cdr</span> <span style="color:#b8860b">move</span>)))))))</code></pre></div>
<p>We create two global variables to hold the map width and height (in cells). The
height is set to 5 cells smaller than the height of the window. This is so that
there is some blank space at the bottom of the window to be used for messages,
which we&rsquo;ll get to in a later tutorial. We also declare the map variable as a
global. This isn&rsquo;t really necessary, and could easily be created as a local
variable in the main function. The reason I&rsquo;ve declared it global is so that it
can be looked at and manipulated in the REPL. It&rsquo;s up to you whether you find
that useful enough to make the variable global.
The changes to the main method are straight forward. We initialize an instance
of the game-map class, and initialize it&rsquo;s tiles. Then we just pass it along to
the render-all method to have it displayed.</p>

<p>If you run the game now, it should look like this:
<img src="/cl-rltut/initial-map-render.png" alt="" /></p>

<p>The three dark tiles are the walls. You&rsquo;ll notice that you can still walk
through them, which isn&rsquo;t correct. We can easily fix that by first adding a
helper method in the &ldquo;game-map-lisp&rdquo; file:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">defmethod</span> <span style="color:#b8860b">blocked-p</span> ((<span style="color:#b8860b">map</span> <span style="color:#b8860b">game-map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>)
  (<span style="color:#b8860b">tile/blocked</span> (<span style="color:#b8860b">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#b8860b">map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>)))</code></pre></div>
<p>This takes in the map and an x,y coordinate, and returns whether that tile is
blocked.</p>

<p>We then just need to call that with the coordinates we&rsquo;re moving to, and if it&rsquo;s
blocked, don&rsquo;t move the player. Update the `(when move)` block in the main
function like:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#b8860b">when</span> <span style="color:#b8860b">move</span>
  (<span style="color:#b8860b">unless</span> (<span style="color:#b8860b">blocked-p</span> *map*
                     (<span style="color:#b8860b">+</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#b8860b">car</span> <span style="color:#b8860b">move</span>))
                     (<span style="color:#b8860b">+</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>) (<span style="color:#b8860b">cdr</span> <span style="color:#b8860b">move</span>)))
    (<span style="color:#b8860b">move</span> <span style="color:#b8860b">player</span> (<span style="color:#b8860b">car</span> <span style="color:#b8860b">move</span>) (<span style="color:#b8860b">cdr</span> <span style="color:#b8860b">move</span>))))</code></pre></div>
<p>Now if you run the game, it should block you from walking through the walls!</p>

<h2 id="conclusion">Conclusion</h2>

<p>That&rsquo;s all for this tutorial. Next we&rsquo;ll be working on procedurally generating
the dungeon map!</p>

<p>You can find the current state of the code on <a href="https://github.com/nwforrer/cl-rltut/tree/part-2">Github</a>. The list of changes since
the previous tutorial can be found at
<a href="https://github.com/nwforrer/cl-rltut/compare/part-1...part-2">https://github.com/nwforrer/cl-rltut/compare/part-1...part-2</a>.</p>

<p>If you run into any issues, or have some feedback, please open an issue on this
blogs <a href="https://github.com/nwforrer/blog/issues">GitHub repository</a>.</p>

<p>Continue to the <a href="/posts/roguelike-tutorial-part3">part 3</a>.</p>

		</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = '';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div><a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148797548-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
