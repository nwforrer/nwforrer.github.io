<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Roguelike tutorial for Common Lisp - Part 3 - Generating a dungeon - nick forrer</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Roguelike tutorial for Common Lisp - Part 3 - Generating a dungeon" />
<meta property="og:description" content="This tutorial series is based on the Python Roguelike Tutorial. This will be covering Part 3 of that tutorial.
In this post, we&rsquo;ll be procedurally generating the dungeon! We will generate randomly sized rooms, and connect them with tunnels for the player and npcs to walk around.
Looping over tiles First things first, we&rsquo;re going to set all tiles to blocked by default. Previously, we had all tiles set as floors, and placed a couple of walls to test." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nwforrer.github.io/posts/roguelike-tutorial-part3/" />
<meta property="article:published_time" content="2019-07-05T17:05:00-04:00" />
<meta property="article:modified_time" content="2019-07-05T17:05:00-04:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Roguelike tutorial for Common Lisp - Part 3 - Generating a dungeon"/>
<meta name="twitter:description" content="This tutorial series is based on the Python Roguelike Tutorial. This will be covering Part 3 of that tutorial.
In this post, we&rsquo;ll be procedurally generating the dungeon! We will generate randomly sized rooms, and connect them with tunnels for the player and npcs to walk around.
Looping over tiles First things first, we&rsquo;re going to set all tiles to blocked by default. Previously, we had all tiles set as floors, and placed a couple of walls to test."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://nwforrer.github.io/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://nwforrer.github.io/css/main.css" /><script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script><script src="https://nwforrer.github.io/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title">nick forrer</h1>
	<div class="site-description"><h2>Game development and Lisp related posts</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/nwforrer" title="Github"><i data-feather="github"></i></a><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/categories/roguelike-tutorial">Roguelike Tutorials</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Roguelike tutorial for Common Lisp - Part 3 - Generating a dungeon</h1>
			<div class="meta">Posted at &mdash; Jul 5, 2019</div>
		</div>

		<div class="markdown">
			

<p>This tutorial series is based on the <a href="http://rogueliketutorials.com">Python Roguelike Tutorial</a>. This will be
covering <a href="http://rogueliketutorials.com/tutorials/tcod/part-3/">Part 3</a> of that tutorial.</p>

<p>In this post, we&rsquo;ll be procedurally generating the dungeon! We will generate
randomly sized rooms, and connect them with tunnels for the player and npcs to
walk around.</p>

<h2 id="looping-over-tiles">Looping over tiles</h2>

<p>First things first, we&rsquo;re going to set all tiles to blocked by default.
Previously, we had all tiles set as floors, and placed a couple of walls to
test. Most dungeon generation algorithms work in the opposite way. They first
block all tiles, and then procedurally carve out rooms and corridors.</p>

<p>Update the initialize-tiles method to match the following:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">initialize-tiles</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>))
  (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">y</span> (<span style="color:#b8860b">game-map/h</span> <span style="color:#00a000">map</span>))
    (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">x</span> (<span style="color:#b8860b">game-map/w</span> <span style="color:#00a000">map</span>))
      (<span style="color:#a2f">setf</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;tile</span> <span style="color:#b8860b">:blocked</span> <span style="color:#800">t</span>)))))</code></pre></div>
<p>Looping over tiles like this is going to be something that happens a few times.
To make this easier, we can define a macro that will loop over all tiles (or a
subsection of tiles), and assign the current tile to a variable for us to use.
The macro looks like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defmacro</span> <span style="color:#b8860b">map-tiles-loop</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">tile-val</span> <span style="color:#a2f;font-weight:bold">&amp;key</span> (<span style="color:#b8860b">row-val</span> (<span style="color:#00a000">gensym</span>)) (<span style="color:#b8860b">col-val</span> (<span style="color:#00a000">gensym</span>)) (<span style="color:#b8860b">x-start</span> <span style="color:#666">0</span>) (<span style="color:#b8860b">y-start</span> <span style="color:#666">0</span>) (<span style="color:#b8860b">x-end</span> <span style="color:#800">nil</span>) (<span style="color:#b8860b">y-end</span> <span style="color:#800">nil</span>)) <span style="color:#a2f;font-weight:bold">&amp;body</span> <span style="color:#b8860b">body</span>)
  <span style="color:#666">`</span>(<span style="color:#a2f">loop</span> <span style="color:#b8860b">:for</span> <span style="color:#666">,</span><span style="color:#b8860b">col-val</span> <span style="color:#b8860b">:from</span> <span style="color:#666">,</span><span style="color:#b8860b">x-start</span> <span style="color:#b8860b">:below</span> (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#00f">null</span> <span style="color:#666">,</span><span style="color:#b8860b">x-end</span>) (<span style="color:#b8860b">game-map/w</span> <span style="color:#666">,</span><span style="color:#00a000">map</span>) <span style="color:#666">,</span><span style="color:#b8860b">x-end</span>)
         <span style="color:#b8860b">:do</span>
            (<span style="color:#a2f">loop</span> <span style="color:#b8860b">:for</span> <span style="color:#666">,</span><span style="color:#b8860b">row-val</span> <span style="color:#b8860b">:from</span> <span style="color:#666">,</span><span style="color:#b8860b">y-start</span> <span style="color:#b8860b">:below</span> (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#00f">null</span> <span style="color:#666">,</span><span style="color:#b8860b">y-end</span>) (<span style="color:#b8860b">game-map/h</span> <span style="color:#666">,</span><span style="color:#00a000">map</span>) <span style="color:#666">,</span><span style="color:#b8860b">y-end</span>)
                  <span style="color:#b8860b">:do</span>
                     (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#666">,</span><span style="color:#b8860b">tile-val</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#666">,</span><span style="color:#00a000">map</span>) <span style="color:#666">,</span><span style="color:#b8860b">col-val</span> <span style="color:#666">,</span><span style="color:#b8860b">row-val</span>)))
                       (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">ignorable</span> <span style="color:#666">,</span><span style="color:#b8860b">tile-val</span>))
                       <span style="color:#666">,@</span><span style="color:#b8860b">body</span>))))</code></pre></div>
<p>The macro takes in a map with all the tiles initialized, a tile-val which holds
the name you want to use for the variable that holds the current tile. It also
takes in some optional parameters via keys: row-val and col-val represent the
names of the x and y variables if you want to access them within the body of the
macro. If not supplied, they are generated. x-start, y-start, x-end, and y-end
allow you to specify the start and end of the tile array to loop over. By
default, it loops over all the tiles.</p>

<p>To see this in use, we can update the initialize-tiles method:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">initialize-tiles</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>))
  (<span style="color:#b8860b">map-tiles-loop</span> (<span style="color:#00a000">map</span> <span style="color:#b8860b">tile</span> <span style="color:#b8860b">:col-val</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:row-val</span> <span style="color:#b8860b">y</span>)
    (<span style="color:#a2f">setf</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;tile</span> <span style="color:#b8860b">:blocked</span> <span style="color:#800">t</span>))))</code></pre></div>
<p>If we were to expand the macro, it looks like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">loop</span> <span style="color:#b8860b">:for</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:from</span> <span style="color:#666">0</span> <span style="color:#b8860b">:below</span> (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#00f">null</span> <span style="color:#800">nil</span>)
                                  (<span style="color:#b8860b">game-map/w</span> <span style="color:#00a000">map</span>)
                                  <span style="color:#800">nil</span>)
        <span style="color:#b8860b">:do</span> (<span style="color:#a2f">loop</span> <span style="color:#b8860b">:for</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:from</span> <span style="color:#666">0</span> <span style="color:#b8860b">:below</span> (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#00f">null</span> <span style="color:#800">nil</span>)
                                            (<span style="color:#b8860b">game-map/h</span> <span style="color:#00a000">map</span>)
                                            <span style="color:#800">nil</span>)
                  <span style="color:#b8860b">:do</span> (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">tile</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>)))
                        (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">ignorable</span> <span style="color:#b8860b">tile</span>))
                        (<span style="color:#a2f">setf</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>)
                                (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;tile</span> <span style="color:#b8860b">:blocked</span>
                                               <span style="color:#b8860b">initial-blocked-value</span>)))))</code></pre></div>
<h2 id="defining-rooms-and-tunnels">Defining rooms and tunnels</h2>

<p>Before we get into the map generation, let&rsquo;s create a helper class that we&rsquo;ll
use to represent rooms:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">rect</span> ()
  ((<span style="color:#b8860b">x1</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:x1</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">rect/x1</span>)
   (<span style="color:#b8860b">x2</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:x2</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">rect/x2</span>)
   (<span style="color:#b8860b">y1</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:y1</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">rect/y1</span>)
   (<span style="color:#b8860b">y2</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:y2</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">rect/y2</span>)))

(<span style="color:#a2f">defmethod</span> <span style="color:#00a000">initialize-instance</span> <span style="color:#b8860b">:after</span> ((<span style="color:#b8860b">rect</span> <span style="color:#b8860b">rect</span>) <span style="color:#a2f;font-weight:bold">&amp;key</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">w</span> <span style="color:#b8860b">h</span>)
  (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">x1</span> <span style="color:#b8860b">x2</span> <span style="color:#b8860b">y1</span> <span style="color:#b8860b">y2</span>) <span style="color:#b8860b">rect</span>
    (<span style="color:#a2f">setf</span> <span style="color:#b8860b">x1</span> <span style="color:#b8860b">x</span>
          <span style="color:#b8860b">y1</span> <span style="color:#b8860b">y</span>
          <span style="color:#b8860b">x2</span> (<span style="color:#00a000">+</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">w</span>)
          <span style="color:#b8860b">y2</span> (<span style="color:#00a000">+</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">h</span>))))</code></pre></div>
<p>rect holds the values to represent the top left and bottom right corners of the
rectangle. We also defined the initialize-instance method for the class, and
allowed x y w h to be passed in, making it easier to create an instance of the class.</p>

<p>Now we can carve rooms into the map:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">set-tile-slots</span> ((<span style="color:#b8860b">tile</span> <span style="color:#b8860b">tile</span>) <span style="color:#a2f;font-weight:bold">&amp;key</span> (<span style="color:#b8860b">blocked</span> <span style="color:#800">nil</span> <span style="color:#b8860b">blocked-supplied-p</span>) (<span style="color:#b8860b">block-sight</span> <span style="color:#800">nil</span> <span style="color:#b8860b">block-sight-supplied-p</span>))
  (<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b8860b">blocked-supplied-p</span>
      (<span style="color:#a2f">setf</span> (<span style="color:#00a000">slot-value</span> <span style="color:#b8860b">tile</span> <span style="color:#b8860b">&#39;blocked</span>) <span style="color:#b8860b">blocked</span>))
  (<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b8860b">block-sight-supplied-p</span>
      (<span style="color:#a2f">setf</span> (<span style="color:#00a000">slot-value</span> <span style="color:#b8860b">tile</span> <span style="color:#b8860b">&#39;block-sight</span>) <span style="color:#b8860b">block-sight</span>)))

(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">create-room</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>) (<span style="color:#00a000">room</span> <span style="color:#b8860b">rect</span>))
  (<span style="color:#b8860b">map-tiles-loop</span> (<span style="color:#00a000">map</span> <span style="color:#b8860b">tile</span>
                   <span style="color:#b8860b">:x-start</span> (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/x1</span> <span style="color:#00a000">room</span>)) <span style="color:#b8860b">:x-end</span> (<span style="color:#b8860b">rect/x2</span> <span style="color:#00a000">room</span>)
                   <span style="color:#b8860b">:y-start</span> (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/y1</span> <span style="color:#00a000">room</span>)) <span style="color:#b8860b">:y-end</span> (<span style="color:#b8860b">rect/y2</span> <span style="color:#00a000">room</span>))
    (<span style="color:#b8860b">set-tile-slots</span> <span style="color:#b8860b">tile</span> <span style="color:#b8860b">:blocked</span> <span style="color:#800">nil</span> <span style="color:#b8860b">:block-sight</span> <span style="color:#800">nil</span>)))</code></pre></div>
<p>We make sure to leave the border of the room untouched, which is why the loop
starts at x1/y1 + 1, and the ending x2/y2 is excluded (remember, the
map-tiles-loop macro uses :below in the loop). This ensures that if we make two
rooms next to each other, one starting at (1,1) going to (6,6), and the other
starting at (7,1) going to (9,6) there will still be a wall in between them.
Otherwise, it would look like one room instead of two rooms.</p>

<p>Now, let&rsquo;s make a couple rooms to test. Create the following method:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">make-map</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>))
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">room-1</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;rect</span> <span style="color:#b8860b">:x</span> <span style="color:#666">20</span> <span style="color:#b8860b">:y</span> <span style="color:#666">15</span> <span style="color:#b8860b">:w</span> <span style="color:#666">10</span> <span style="color:#b8860b">:h</span> <span style="color:#666">15</span>))
        (<span style="color:#b8860b">room-2</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;rect</span> <span style="color:#b8860b">:x</span> <span style="color:#666">35</span> <span style="color:#b8860b">:y</span> <span style="color:#666">15</span> <span style="color:#b8860b">:w</span> <span style="color:#666">10</span> <span style="color:#b8860b">:h</span> <span style="color:#666">15</span>)))
    (<span style="color:#b8860b">create-room</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">room-1</span>)
    (<span style="color:#b8860b">create-room</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">room-2</span>)))</code></pre></div>
<p>In order to call this method in our main function, we&rsquo;re going to update our
game loop structure a bit. We&rsquo;ll add a new game-tick function, and update the main function to look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">game-tick</span> (<span style="color:#b8860b">player</span> <span style="color:#b8860b">entities</span> <span style="color:#00a000">map</span>)
  (<span style="color:#b8860b">render-all</span> <span style="color:#b8860b">entities</span> <span style="color:#00a000">map</span>)
  (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">action</span> (<span style="color:#b8860b">handle-keys</span>))
         (<span style="color:#b8860b">move</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:move</span>))
         (<span style="color:#b8860b">exit</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:quit</span>)))
    (<span style="color:#a2f">when</span> <span style="color:#b8860b">move</span>
      (<span style="color:#a2f">unless</span> (<span style="color:#b8860b">blocked-p</span> <span style="color:#00a000">map</span>
                         (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>))
                         (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>)))
        (<span style="color:#b8860b">move</span> <span style="color:#b8860b">player</span> (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))))

    <span style="color:#b8860b">exit</span>))

(<span style="color:#a2f">defun</span> <span style="color:#b8860b">main</span> ()
  (<span style="color:#b8860b">blt:with-terminal</span>
      (<span style="color:#b8860b">config</span>)
    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">player</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span>
                                  <span style="color:#b8860b">:x</span> (<span style="color:#00a000">/</span> *screen-width* <span style="color:#666">2</span>)
                                  <span style="color:#b8860b">:y</span> (<span style="color:#00a000">/</span> *screen-height* <span style="color:#666">2</span>)
                                  <span style="color:#b8860b">:char</span> <span style="color:#b44">#\@</span>
                                  <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:white</span>)))
          (<span style="color:#b8860b">npc</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span>
                               <span style="color:#b8860b">:x</span> (<span style="color:#00a000">-</span> (<span style="color:#00a000">/</span> *screen-width* <span style="color:#666">2</span>) <span style="color:#666">5</span>)
                               <span style="color:#b8860b">:y</span> (<span style="color:#00a000">/</span> *screen-height* <span style="color:#666">2</span>)
                               <span style="color:#b8860b">:char</span> <span style="color:#b44">#\@</span>
                               <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:yellow</span>)))
          (<span style="color:#b8860b">entities</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">npc</span>))
          (<span style="color:#00a000">map</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;game-map</span> <span style="color:#b8860b">:w</span> *map-width* <span style="color:#b8860b">:h</span> *map-height*)))
      (<span style="color:#b8860b">make-map</span> (<span style="color:#00a000">map</span>))

      (<span style="color:#a2f">do</span> ((<span style="color:#b8860b">exit</span> <span style="color:#800">nil</span> (<span style="color:#b8860b">game-tick</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">entities</span> <span style="color:#00a000">map</span>)))
          (<span style="color:#b8860b">exit</span>)))))</code></pre></div>
<p>You can also remove the <strong>map</strong> global variable we had before, as we now create
the map locally. While we&rsquo;re at it, we don&rsquo;t really need the initialize-tiles method in the
game-map.lisp file. Since we always want the tiles initialized, we&rsquo;ll move that
code into the initialize-instance method:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defmethod</span> <span style="color:#00a000">initialize-instance</span> <span style="color:#b8860b">:after</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>) <span style="color:#a2f;font-weight:bold">&amp;key</span> (<span style="color:#b8860b">initial-blocked-value</span> <span style="color:#800">t</span>))
  (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) (<span style="color:#00a000">make-array</span> (<span style="color:#00f">list</span> (<span style="color:#b8860b">game-map/w</span> <span style="color:#00a000">map</span>) (<span style="color:#b8860b">game-map/h</span> <span style="color:#00a000">map</span>))))
  (<span style="color:#b8860b">map-tiles-loop</span> (<span style="color:#00a000">map</span> <span style="color:#b8860b">tile</span> <span style="color:#b8860b">:col-val</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:row-val</span> <span style="color:#b8860b">y</span>)
                  (<span style="color:#a2f">setf</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;tile</span> <span style="color:#b8860b">:blocked</span> <span style="color:#b8860b">initial-blocked-value</span>))))</code></pre></div>
<p>Now if you run the game, it should look like this:
<img src="/cl-rltut/create-test-rooms.png" alt="" /></p>

<p>With the rooms being created, we should also create tunnels to connect them.
For our generation code, the tunnels will just be a combination of a horizontal
and vertical section, so there won&rsquo;t be any winding tunnels. Add the following
two methods:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">create-h-tunnel</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>) <span style="color:#b8860b">x1</span> <span style="color:#b8860b">x2</span> <span style="color:#b8860b">y</span>)
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">start-x</span> (<span style="color:#00a000">min</span> <span style="color:#b8860b">x1</span> <span style="color:#b8860b">x2</span>))
        (<span style="color:#b8860b">end-x</span> (<span style="color:#00a000">max</span> <span style="color:#b8860b">x1</span> <span style="color:#b8860b">x2</span>)))
    (<span style="color:#b8860b">map-tiles-loop</span> (<span style="color:#00a000">map</span> <span style="color:#b8860b">tile</span>
                     <span style="color:#b8860b">:x-start</span> <span style="color:#b8860b">start-x</span> <span style="color:#b8860b">:x-end</span> (<span style="color:#00a000">1+</span> <span style="color:#b8860b">end-x</span>)
                     <span style="color:#b8860b">:y-start</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:y-end</span> (<span style="color:#00a000">1+</span> <span style="color:#b8860b">y</span>))
      (<span style="color:#b8860b">set-tile-slots</span> <span style="color:#b8860b">tile</span> <span style="color:#b8860b">:blocked</span> <span style="color:#800">nil</span> <span style="color:#b8860b">:block-sight</span> <span style="color:#800">nil</span>))))

(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">create-v-tunnel</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>) <span style="color:#b8860b">y1</span> <span style="color:#b8860b">y2</span> <span style="color:#b8860b">x</span>)
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">start-y</span> (<span style="color:#00a000">min</span> <span style="color:#b8860b">y1</span> <span style="color:#b8860b">y2</span>))
        (<span style="color:#b8860b">end-y</span> (<span style="color:#00a000">max</span> <span style="color:#b8860b">y1</span> <span style="color:#b8860b">y2</span>)))
    (<span style="color:#b8860b">map-tiles-loop</span> (<span style="color:#00a000">map</span> <span style="color:#b8860b">tile</span>
                     <span style="color:#b8860b">:x-start</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:x-end</span> (<span style="color:#00a000">1+</span> <span style="color:#b8860b">x</span>)
                     <span style="color:#b8860b">:y-start</span> <span style="color:#b8860b">start-y</span> <span style="color:#b8860b">:y-end</span> (<span style="color:#00a000">1+</span> <span style="color:#b8860b">end-y</span>))
      (<span style="color:#b8860b">set-tile-slots</span> <span style="color:#b8860b">tile</span> <span style="color:#b8860b">:blocked</span> <span style="color:#800">nil</span> <span style="color:#b8860b">:block-sight</span> <span style="color:#800">nil</span>))))</code></pre></div>
<p>Let&rsquo;s test it out by updating our make-map method:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">make-map</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>))
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">room-1</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;rect</span> <span style="color:#b8860b">:x</span> <span style="color:#666">20</span> <span style="color:#b8860b">:y</span> <span style="color:#666">15</span> <span style="color:#b8860b">:w</span> <span style="color:#666">10</span> <span style="color:#b8860b">:h</span> <span style="color:#666">15</span>))
        (<span style="color:#b8860b">room-2</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;rect</span> <span style="color:#b8860b">:x</span> <span style="color:#666">35</span> <span style="color:#b8860b">:y</span> <span style="color:#666">15</span> <span style="color:#b8860b">:w</span> <span style="color:#666">10</span> <span style="color:#b8860b">:h</span> <span style="color:#666">15</span>)))
    (<span style="color:#b8860b">create-room</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">room-1</span>)
    (<span style="color:#b8860b">create-room</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">room-2</span>))

  (<span style="color:#b8860b">create-h-tunnel</span> <span style="color:#00a000">map</span> <span style="color:#666">25</span> <span style="color:#666">40</span> <span style="color:#666">23</span>))</code></pre></div>
<p>Running the game now should look like:
<img src="/cl-rltut/test-tunnel.png" alt="" /></p>

<h2 id="generating-the-dungeon">Generating the dungeon</h2>

<p>Now that we can create rooms and tunnels, it&rsquo;s time to move on to the actual
dungeon generation. It will be relatively basic: we&rsquo;ll create a bunch of rooms,
make sure they don&rsquo;t overlap, and connect them together.</p>

<p>First, add a couple methods to the rect class to assist with detecting when two
rooms overlap:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">center</span> ((<span style="color:#b8860b">rect</span> <span style="color:#b8860b">rect</span>))
  (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">x1</span> <span style="color:#b8860b">x2</span> <span style="color:#b8860b">y1</span> <span style="color:#b8860b">y2</span>) <span style="color:#b8860b">rect</span>
    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">center-x</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">+</span> <span style="color:#b8860b">x1</span> <span style="color:#b8860b">x2</span>) <span style="color:#666">2</span>)))
          (<span style="color:#b8860b">center-y</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">+</span> <span style="color:#b8860b">y1</span> <span style="color:#b8860b">y2</span>) <span style="color:#666">2</span>))))
      (<span style="color:#00a000">values</span> <span style="color:#b8860b">center-x</span> <span style="color:#b8860b">center-y</span>))))

(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">intersect</span> ((<span style="color:#b8860b">rect</span> <span style="color:#b8860b">rect</span>) (<span style="color:#b8860b">other</span> <span style="color:#b8860b">rect</span>))
  <span style="color:#b44">&#34;Returns T if this RECT intersects with OTHER&#34;</span>
  (<span style="color:#a2f">and</span> (<span style="color:#00a000">&lt;=</span> (<span style="color:#b8860b">rect/x1</span> <span style="color:#b8860b">rect</span>) (<span style="color:#b8860b">rect/x2</span> <span style="color:#b8860b">other</span>))
       (<span style="color:#00a000">&gt;=</span> (<span style="color:#b8860b">rect/x2</span> <span style="color:#b8860b">rect</span>) (<span style="color:#b8860b">rect/x1</span> <span style="color:#b8860b">other</span>))
       (<span style="color:#00a000">&lt;=</span> (<span style="color:#b8860b">rect/y1</span> <span style="color:#b8860b">rect</span>) (<span style="color:#b8860b">rect/y2</span> <span style="color:#b8860b">other</span>))
       (<span style="color:#00a000">&gt;=</span> (<span style="color:#b8860b">rect/y2</span> <span style="color:#b8860b">rect</span>) (<span style="color:#b8860b">rect/y1</span> <span style="color:#b8860b">other</span>))))</code></pre></div>
<p>Add a couple of variables to the cl-rltut.lisp file, to use with our generation:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defparameter</span> *room-max-size* <span style="color:#666">10</span>)
(<span style="color:#a2f">defparameter</span> *room-min-size* <span style="color:#666">6</span>)
(<span style="color:#a2f">defparameter</span> *max-rooms* <span style="color:#666">30</span>)</code></pre></div>
<p>Now, update the make-map method signature to take in those variables, and start
calculating the position and size for the rooms:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">make-map</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>) <span style="color:#b8860b">max-rooms</span> <span style="color:#b8860b">room-min-size</span> <span style="color:#b8860b">room-max-size</span> <span style="color:#b8860b">map-width</span> <span style="color:#b8860b">map-height</span> <span style="color:#b8860b">player</span>)
  (<span style="color:#a2f">do*</span> ((<span style="color:#b8860b">rooms</span> <span style="color:#800">nil</span>)
        (<span style="color:#b8860b">num-rooms</span> <span style="color:#666">0</span>)
        (<span style="color:#b8860b">room-index</span> <span style="color:#666">0</span> (<span style="color:#00a000">1+</span> <span style="color:#b8860b">room-index</span>))
        (<span style="color:#b8860b">w</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">-</span> <span style="color:#b8860b">room-max-size</span> <span style="color:#b8860b">room-min-size</span>)) <span style="color:#b8860b">room-min-size</span>)
           (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">-</span> <span style="color:#b8860b">room-max-size</span> <span style="color:#b8860b">room-min-size</span>)) <span style="color:#b8860b">room-min-size</span>))
        (<span style="color:#b8860b">h</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">-</span> <span style="color:#b8860b">room-max-size</span> <span style="color:#b8860b">room-min-size</span>)) <span style="color:#b8860b">room-min-size</span>)
           (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">-</span> <span style="color:#b8860b">room-max-size</span> <span style="color:#b8860b">room-min-size</span>)) <span style="color:#b8860b">room-min-size</span>))
        (<span style="color:#b8860b">x</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">-</span> <span style="color:#b8860b">map-width</span> <span style="color:#b8860b">w</span>))
           (<span style="color:#00a000">random</span> (<span style="color:#00a000">-</span> <span style="color:#b8860b">map-width</span> <span style="color:#b8860b">w</span>)))
        (<span style="color:#b8860b">y</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">-</span> <span style="color:#b8860b">map-height</span> <span style="color:#b8860b">h</span>))
           (<span style="color:#00a000">random</span> (<span style="color:#00a000">-</span> <span style="color:#b8860b">map-height</span> <span style="color:#b8860b">h</span>)))
        (<span style="color:#b8860b">new-room</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;rect</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:w</span> <span style="color:#b8860b">w</span> <span style="color:#b8860b">:h</span> <span style="color:#b8860b">h</span>)
                  (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;rect</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:w</span> <span style="color:#b8860b">w</span> <span style="color:#b8860b">:h</span> <span style="color:#b8860b">h</span>))
        (<span style="color:#b8860b">can-place-p</span> <span style="color:#800">t</span> <span style="color:#800">t</span>))
       ((<span style="color:#00a000">&gt;=</span> <span style="color:#b8860b">room-index</span> <span style="color:#b8860b">max-rooms</span>))))</code></pre></div>
<p>We&rsquo;re calculating each room&rsquo;s width and height as a random size between the
room-min-size and room-max-size. The x and y position is a random point within
the map. We then create a new-room variable with these calculated values. The
rooms variable is going to hold all the rooms that we create, so we can check
for overlaps, and the room-index and num-rooms will help with looking up the
previous room. When we generate the tunnels, we&rsquo;ll just be connecting the
current room to the previously created room.</p>

<p>Update the do* body to check for intersections:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">dolist</span> (<span style="color:#b8860b">other-room</span> <span style="color:#b8860b">rooms</span>)
  (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#b8860b">intersect</span> <span style="color:#b8860b">new-room</span> <span style="color:#b8860b">other-room</span>)
      (<span style="color:#a2f">setf</span> <span style="color:#b8860b">can-place-p</span> <span style="color:#800">nil</span>)))</code></pre></div>
<p>That just loops over the rooms list (which we&rsquo;ll populate later), and checks if
the current room we&rsquo;re placing intersects with any of the other rooms. If there
is an intersection, we&rsquo;re setting the can-place-p variable to show that we
shouldn&rsquo;t actually create this room.</p>

<p>After that dolist loop, we can create the new room, and connect it to the
previous room:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-common-lisp" data-lang="common-lisp">(<span style="color:#a2f">when</span> <span style="color:#b8860b">can-place-p</span>
  (<span style="color:#b8860b">create-room</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">new-room</span>)
  (<span style="color:#a2f">multiple-value-bind</span> (<span style="color:#b8860b">new-x</span> <span style="color:#b8860b">new-y</span>) (<span style="color:#b8860b">center</span> <span style="color:#b8860b">new-room</span>)
    (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#00a000">zerop</span> <span style="color:#b8860b">num-rooms</span>)
        (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">new-x</span>
              (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">new-y</span>)
        (<span style="color:#a2f">multiple-value-bind</span> (<span style="color:#b8860b">prev-x</span> <span style="color:#b8860b">prev-y</span>) (<span style="color:#b8860b">center</span> (<span style="color:#00a000">car</span> (<span style="color:#00a000">last</span> <span style="color:#b8860b">rooms</span>)))
          (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">=</span> (<span style="color:#00a000">random</span> <span style="color:#666">2</span>) <span style="color:#666">1</span>)
                 (<span style="color:#b8860b">create-h-tunnel</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">prev-x</span> <span style="color:#b8860b">new-x</span> <span style="color:#b8860b">prev-y</span>)
                 (<span style="color:#b8860b">create-v-tunnel</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">prev-y</span> <span style="color:#b8860b">new-y</span> <span style="color:#b8860b">new-x</span>))
                (<span style="color:#800">t</span>
                 (<span style="color:#b8860b">create-v-tunnel</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">prev-y</span> <span style="color:#b8860b">new-y</span> <span style="color:#b8860b">prev-x</span>)
                 (<span style="color:#b8860b">create-h-tunnel</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">prev-x</span> <span style="color:#b8860b">new-x</span> <span style="color:#b8860b">new-y</span>)))))
    (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#00f">null</span> <span style="color:#b8860b">rooms</span>)
        (<span style="color:#a2f">setf</span> <span style="color:#b8860b">rooms</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">new-room</span>))
        (<span style="color:#a2f">push</span> <span style="color:#b8860b">new-room</span> (<span style="color:#00a000">cdr</span> (<span style="color:#00a000">last</span> <span style="color:#b8860b">rooms</span>))))
    (<span style="color:#a2f">incf</span> <span style="color:#b8860b">num-rooms</span>)))</code></pre></div>
<p>The tunnel creation randomly decides whether to use a horizontal or vertical
tunnel first, so that it doesn&rsquo;t look so uniform. The tunnel is created from the
center of the previous room, to the center of the new room. After the room is
created, it&rsquo;s added to the rooms list so that we can check for overlaps in the
next rooms.</p>

<p>Running the code now, you should see a complete dungeon:
<img src="/cl-rltut/dungeon-generation.png" alt="" /></p>

<p>Note that since it&rsquo;s randomly generated, your output won&rsquo;t look exactly the same.</p>

<h2 id="conclusion">Conclusion</h2>

<p>That&rsquo;s all there is to it. It&rsquo;s a pretty simple algorithm, but gives decent
results. There are plenty of other algorithms to generate different looking
dungeons. For example, you can use a type of <a href="http://journal.stuffwithstuff.com/2014/12/21/rooms-and-mazes/">maze algorithm</a> to make the tunnels
between rooms more interesting.</p>

<p>You can find the current state of the code on <a href="https://github.com/nwforrer/cl-rltut/tree/part-3">Github</a>. The list of changes since
the previous tutorial can be found at
<a href="https://github.com/nwforrer/cl-rltut/compare/part-2...part-3">https://github.com/nwforrer/cl-rltut/compare/part-2...part-3</a>.</p>

<p>If you run into any issues, or have some feedback, please open an issue on this
blogs <a href="https://github.com/nwforrer/blog/issues">GitHub repository</a>.</p>

<p>Continue to <a href="/posts/roguelike-tutorial-part4">part 4</a>.</p>

		</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = '';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div><a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148797548-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
