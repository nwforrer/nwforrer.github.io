<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Roguelike tutorial for Common Lisp - Part 6 - Combat - nick forrer</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Roguelike tutorial for Common Lisp - Part 6 - Combat" />
<meta property="og:description" content="This tutorial series is based on the Python Roguelike Tutorial. This will be covering Part 6 of that tutorial.
In this part, we will be adding a combat system, allowing players to kill monsters, as well as be killed. To accomplish this, we will also be adding a component system, and implementing an A* pathfinding algorithm. This will be a relatively long post, so let&rsquo;s get right into it.
Components For any enemies that can fight and take damage, we&rsquo;ll be creating a fighter &ldquo;component,&rdquo; which will contain the entities hp, attack, and defense." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nwforrer.github.io/posts/roguelike-tutorial-part6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-10-16T06:55:00-04:00" />
<meta property="article:modified_time" content="2019-10-16T06:55:00-04:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Roguelike tutorial for Common Lisp - Part 6 - Combat"/>
<meta name="twitter:description" content="This tutorial series is based on the Python Roguelike Tutorial. This will be covering Part 6 of that tutorial.
In this part, we will be adding a combat system, allowing players to kill monsters, as well as be killed. To accomplish this, we will also be adding a component system, and implementing an A* pathfinding algorithm. This will be a relatively long post, so let&rsquo;s get right into it.
Components For any enemies that can fight and take damage, we&rsquo;ll be creating a fighter &ldquo;component,&rdquo; which will contain the entities hp, attack, and defense."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://nwforrer.github.io/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://nwforrer.github.io/css/main.css" /><script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script><script src="https://nwforrer.github.io/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title">nick forrer</h1>
	<div class="site-description"><h2>Game development and Lisp related posts</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/nwforrer" title="Github"><i data-feather="github"></i></a><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/categories/roguelike-tutorial">Roguelike Tutorials</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Roguelike tutorial for Common Lisp - Part 6 - Combat</h1>
			<div class="meta">Posted at &mdash; Oct 16, 2019</div>
		</div>

		<div class="markdown">
			<p>This tutorial series is based on the <a href="http://rogueliketutorials.com">Python Roguelike Tutorial</a>. This will be
covering <a href="http://rogueliketutorials.com/tutorials/tcod/part-6/">Part 6</a> of that tutorial.</p>
<p>In this part, we will be adding a combat system, allowing players to kill monsters,
as well as be killed. To accomplish this, we will also be adding a component
system, and implementing an A* pathfinding algorithm. This will be a
relatively long post, so let&rsquo;s get right into it.</p>
<h2 id="components">Components</h2>
<p>For any enemies that can fight and take damage, we&rsquo;ll be creating a fighter
&ldquo;component,&rdquo; which will contain the entities hp, attack, and defense. This is
known as &ldquo;composition,&rdquo; rather than inheritance. In an inheritance model, we
would likely have created a new Fighter class that inherits from the Entity
class. These types of hierarchies can start out fine, but will quickly become
difficult to work with.</p>
<p>Create a new file, components.lisp, with the new component and fighter classes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">in-package</span> <span style="color:#b8860b">:cl-rltut</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">component</span> ()
</span></span><span style="display:flex;"><span>  ((<span style="color:#b8860b">owner</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:owner</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">component/owner</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">fighter</span> (<span style="color:#b8860b">component</span>)
</span></span><span style="display:flex;"><span>  ((<span style="color:#b8860b">max-hp</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:max-hp</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">fighter/max-hp</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">hp</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:hp</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">fighter/hp</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">defense</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:defense</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">fighter/defense</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">power</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:power</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">fighter/power</span>)))
</span></span></code></pre></div><p>We&rsquo;ll also be creating a component to represent an enemies AI behavior, along
with a &ldquo;take-turn&rdquo; method to execute the behavior:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">basic-monster</span> (<span style="color:#b8860b">component</span>) ())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defgeneric</span> <span style="color:#b8860b">take-turn</span> (<span style="color:#b8860b">component</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">take-turn</span> ((<span style="color:#b8860b">component</span> <span style="color:#b8860b">basic-monster</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#00a000">format</span> <span style="color:#800">t</span> <span style="color:#b44">&#34;The ~A wonders when it will get to move.&#34;</span> (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">component</span>)))
</span></span></code></pre></div><p>New we need to add slots to the &ldquo;entity&rdquo; class to hold the two new components.
They will be optional, since not all entities will have the components. We&rsquo;ll
also need to set the &ldquo;owner&rdquo; slot on the components to the entity that they are
being attached to, so that the components can get information for their entity,
such as the entity position.</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">entity</span> ()
</span></span><span style="display:flex;"><span>  ((<span style="color:#b8860b">name</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:name</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/name</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">x</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/x</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">y</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/y</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#00a000">char</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:char</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/char</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">color</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:color</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/color</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">blocks</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:blocks</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/blocks</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>   (<span style="color:#b8860b">fighter</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>   (<span style="color:#b8860b">ai</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:ai</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#00a000">initialize-instance</span> <span style="color:#b8860b">:after</span> ((<span style="color:#b8860b">entity</span> <span style="color:#b8860b">entity</span>) <span style="color:#a2f;font-weight:bold">&amp;rest</span> <span style="color:#b8860b">initargs</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>  (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">ignore</span> <span style="color:#b8860b">initargs</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>  (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">fighter</span> <span style="color:#b8860b">ai</span>) <span style="color:#b8860b">entity</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>    (<span style="color:#a2f">when</span> <span style="color:#b8860b">fighter</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>      (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">fighter</span>) <span style="color:#b8860b">entity</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>    (<span style="color:#a2f">when</span> <span style="color:#b8860b">ai</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>      (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">ai</span>) <span style="color:#b8860b">entity</span>))))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>Now, when creating the player entity, we&rsquo;ll want to create a fighter component
to add (in the main function in cl-rltut.lisp):</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#666">...</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>(<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">fighter-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;fighter</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                         <span style="color:#b8860b">:hp</span> <span style="color:#666">30</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                         <span style="color:#b8860b">:defense</span> <span style="color:#666">2</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                         <span style="color:#b8860b">:power</span> <span style="color:#666">5</span>))
</span></span><span style="display:flex;"><span>       (<span style="color:#b8860b">player</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Player&#34;</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#b8860b">:x</span> (<span style="color:#00a000">/</span> *screen-width* <span style="color:#666">2</span>)
</span></span><span style="display:flex;"><span>                              <span style="color:#b8860b">:y</span> (<span style="color:#00a000">/</span> *screen-height* <span style="color:#666">2</span>)
</span></span><span style="display:flex;"><span>                              <span style="color:#b8860b">:char</span> <span style="color:#b44">#\@</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:white</span>)
</span></span><span style="display:flex;"><span>                              <span style="color:#b8860b">:blocks</span> <span style="color:#800">t</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                              <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">fighter-component</span>))
</span></span><span style="display:flex;"><span>       (<span style="color:#b8860b">entities</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">player</span>))
</span></span><span style="display:flex;"><span>       (<span style="color:#00a000">map</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;game-map</span> <span style="color:#b8860b">:w</span> *map-width* <span style="color:#b8860b">:h</span> *map-height*)))
</span></span><span style="display:flex;"><span>  <span style="color:#666">...</span>)</span></span></code></pre></td></tr></table>
</div>
</div>
<p>And we&rsquo;ll do the same for the monsters (in the place-entities function in
game-map.lisp):</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">place-entities</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>) (<span style="color:#00a000">room</span> <span style="color:#b8860b">rect</span>) <span style="color:#b8860b">entities</span> <span style="color:#b8860b">max-enemies-per-room</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">num-monsters</span> (<span style="color:#00a000">random</span> <span style="color:#b8860b">max-enemies-per-room</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">monster-index</span> <span style="color:#b8860b">num-monsters</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">x</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">rect/x2</span> <span style="color:#00a000">room</span>) (<span style="color:#b8860b">rect/x1</span> <span style="color:#00a000">room</span>) <span style="color:#666">1</span>) <span style="color:#666">2</span>))) (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/x1</span> <span style="color:#00a000">room</span>))))
</span></span><span style="display:flex;"><span>            (<span style="color:#b8860b">y</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">rect/y2</span> <span style="color:#00a000">room</span>) (<span style="color:#b8860b">rect/y1</span> <span style="color:#00a000">room</span>) <span style="color:#666">1</span>) <span style="color:#666">2</span>))) (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/y1</span> <span style="color:#00a000">room</span>)))))
</span></span><span style="display:flex;"><span>        (<span style="color:#a2f">unless</span> (<span style="color:#b8860b">entity-at</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">&lt;</span> (<span style="color:#00a000">random</span> <span style="color:#666">100</span>) <span style="color:#666">80</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                 (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">fighter-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;fighter</span> <span style="color:#b8860b">:hp</span> <span style="color:#666">10</span> <span style="color:#b8860b">:defense</span> <span style="color:#666">0</span> <span style="color:#b8860b">:power</span> <span style="color:#666">3</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                        (<span style="color:#b8860b">ai-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;basic-monster</span>))
</span></span><span style="display:flex;"><span>                        (<span style="color:#b8860b">orc</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span> <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Orc&#34;</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:green</span>) <span style="color:#b8860b">:char</span> <span style="color:#b44">#\o</span> <span style="color:#b8860b">:blocks</span> <span style="color:#800">t</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                                    <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">fighter-component</span> <span style="color:#b8860b">:ai</span> <span style="color:#b8860b">ai-component</span>)))
</span></span><span style="display:flex;"><span>                   (<span style="color:#00a000">nconc</span> <span style="color:#b8860b">entities</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">orc</span>))))
</span></span><span style="display:flex;"><span>                (<span style="color:#800">t</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                 (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">fighter-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;fighter</span> <span style="color:#b8860b">:hp</span> <span style="color:#666">16</span> <span style="color:#b8860b">:defense</span> <span style="color:#666">1</span> <span style="color:#b8860b">:power</span> <span style="color:#666">4</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                        (<span style="color:#b8860b">ai-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;basic-monster</span>))
</span></span><span style="display:flex;"><span>                        (<span style="color:#b8860b">troll</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span> <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Troll&#34;</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:yellow</span>) <span style="color:#b8860b">:char</span> <span style="color:#b44">#\T</span> <span style="color:#b8860b">:blocks</span> <span style="color:#800">t</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                                      <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">fighter-component</span> <span style="color:#b8860b">:ai</span> <span style="color:#b8860b">ai-component</span>)))
</span></span><span style="display:flex;"><span>                   (<span style="color:#00a000">nconc</span> <span style="color:#b8860b">entities</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">troll</span>))))))))))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>Now we can update the game loop to call the take-turn function on all the
entities with the AI component:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">dolist</span> (<span style="color:#b8860b">entity</span> (<span style="color:#00a000">remove-if-not</span> <span style="color:#00a000">#&#39;</span><span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#b8860b">take-turn</span> (<span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">entity</span>)))
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>You can now run the game again. The only difference you&rsquo;ll see is the message
being printed out by the monsters is different, but we&rsquo;ve set up a working
component system. Next we&rsquo;ll want to update the AI component to move towards the
player and attack.</p>
<h2 id="basic-monster-ai">Basic monster AI</h2>
<p>Add a &ldquo;move-towards&rdquo; method to the entity class, which will move an the entity
towards a target location. It will only move in a straight line towards the
target, and stop if it hits a wall. We&rsquo;ll add pathfinding a little later.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defgeneric</span> <span style="color:#b8860b">move-towards</span> (<span style="color:#b8860b">e</span> <span style="color:#b8860b">target-x</span> <span style="color:#b8860b">target-y</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">move-towards</span> ((<span style="color:#b8860b">e</span> <span style="color:#b8860b">entity</span>) <span style="color:#b8860b">target-x</span> <span style="color:#b8860b">target-y</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) <span style="color:#b8860b">e</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">dx</span> (<span style="color:#00a000">-</span> <span style="color:#b8860b">target-x</span> <span style="color:#b8860b">x</span>))
</span></span><span style="display:flex;"><span>           (<span style="color:#b8860b">dy</span> (<span style="color:#00a000">-</span> <span style="color:#b8860b">target-y</span> <span style="color:#b8860b">y</span>))
</span></span><span style="display:flex;"><span>           (<span style="color:#b8860b">distance</span> (<span style="color:#00a000">sqrt</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">expt</span> <span style="color:#b8860b">dx</span> <span style="color:#666">2</span>) (<span style="color:#00a000">expt</span> <span style="color:#b8860b">dy</span> <span style="color:#666">2</span>)))))
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">setf</span> <span style="color:#b8860b">dx</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> <span style="color:#b8860b">dx</span> <span style="color:#b8860b">distance</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">dy</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> <span style="color:#b8860b">dy</span> <span style="color:#b8860b">distance</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">unless</span> (<span style="color:#a2f">or</span> (<span style="color:#b8860b">blocked-p</span> <span style="color:#00a000">map</span> (<span style="color:#00a000">+</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">dx</span>) (<span style="color:#00a000">+</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">dy</span>))
</span></span><span style="display:flex;"><span>                  (<span style="color:#b8860b">blocking-entity-at</span> <span style="color:#b8860b">entities</span> (<span style="color:#00a000">+</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">dx</span>) (<span style="color:#00a000">+</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">dy</span>)))
</span></span><span style="display:flex;"><span>        (<span style="color:#b8860b">move</span> <span style="color:#b8860b">e</span> <span style="color:#b8860b">dx</span> <span style="color:#b8860b">dy</span>)))))
</span></span></code></pre></div><p>Also add a &ldquo;distance-to&rdquo; method, which we&rsquo;ll use to decide whether a monster is
close enough to attack the player:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">distance-to</span> ((<span style="color:#b8860b">e</span> <span style="color:#b8860b">entity</span>) (<span style="color:#b8860b">other</span> <span style="color:#b8860b">entity</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">dx</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">other</span>) (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">e</span>)))
</span></span><span style="display:flex;"><span>        (<span style="color:#b8860b">dy</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">other</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">e</span>))))
</span></span><span style="display:flex;"><span>    (<span style="color:#00a000">sqrt</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">expt</span> <span style="color:#b8860b">dx</span> <span style="color:#666">2</span>) (<span style="color:#00a000">expt</span> <span style="color:#b8860b">dy</span> <span style="color:#666">2</span>)))))
</span></span></code></pre></div><p>Now update the &ldquo;take-turn&rdquo; method to move towards the player. We&rsquo;ll move the
monster as long as it&rsquo;s within the FOV of the player. If the monster is one tile
away from the player, then print out an attack message.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defgeneric</span> <span style="color:#b8860b">take-turn</span> (<span style="color:#b8860b">component</span> <span style="color:#b8860b">target</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">take-turn</span> ((<span style="color:#b8860b">component</span> <span style="color:#b8860b">basic-monster</span>) <span style="color:#b8860b">target</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">monster</span> (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">component</span>))
</span></span><span style="display:flex;"><span>         (<span style="color:#b8860b">in-sight</span> (<span style="color:#b8860b">tile/visible</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">monster</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">monster</span>)))))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">when</span> <span style="color:#b8860b">in-sight</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">&gt;=</span> (<span style="color:#b8860b">distance-to</span> <span style="color:#b8860b">monster</span> <span style="color:#b8860b">target</span>) <span style="color:#666">2</span>)
</span></span><span style="display:flex;"><span>             (<span style="color:#b8860b">move-towards</span> <span style="color:#b8860b">monster</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">target</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">target</span>) <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex;"><span>            ((<span style="color:#00a000">&gt;</span> (<span style="color:#b8860b">fighter/hp</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">target</span>)) <span style="color:#666">0</span>)
</span></span><span style="display:flex;"><span>             (<span style="color:#00a000">format</span> <span style="color:#800">t</span> <span style="color:#b44">&#34;The ~A insults you! Your ego is damaged!&#34;</span> (<span style="color:#b8860b">entity/name</span> <span style="color:#b8860b">monster</span>)))))))
</span></span></code></pre></div><p>We&rsquo;ll also need to update the call to &ldquo;take-turn&rdquo; to pass in the target, map,
and entities parameters.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">dolist</span> (<span style="color:#b8860b">entity</span> (<span style="color:#00a000">remove-if-not</span> <span style="color:#00a000">#&#39;</span><span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#b8860b">take-turn</span> (<span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">entity</span>) <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>))
</span></span></code></pre></div><p>Now you can run the game, and the enemies will chase you. When they get close
enough they&rsquo;ll print out a message insulting you.</p>
<p>Currently, the monsters are able to attack the player from a diagonal position,
but the player can only attack up/down/left/right, and both the player and
monsters can only move in four directions. We can either stop the monsters from
attacking diagonally, or allow all entities to attack and move in eight
directions. We&rsquo;ll implement the latter. First, let&rsquo;s allow the player to move in
eight directions. We&rsquo;ll use the &ldquo;vim keys&rdquo; for movement. Update the
&ldquo;handle-keys&rdquo; function as follows:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-keys</span> ()
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">when</span> (<span style="color:#b8860b">blt:has-input-p</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#b8860b">blt:key-case</span> (<span style="color:#b8860b">blt:read</span>)
</span></span><span style="display:flex;"><span>                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:up</span> <span style="color:#b8860b">:k</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">-1</span>)))
</span></span><span style="display:flex;"><span>                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:down</span> <span style="color:#b8860b">:j</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">1</span>)))
</span></span><span style="display:flex;"><span>                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:left</span> <span style="color:#b8860b">:h</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">0</span>)))
</span></span><span style="display:flex;"><span>                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:right</span> <span style="color:#b8860b">:l</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">0</span>)))
</span></span><span style="display:flex;"><span>                  (<span style="color:#b8860b">:y</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">-1</span>)))
</span></span><span style="display:flex;"><span>                  (<span style="color:#b8860b">:u</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">-1</span>)))
</span></span><span style="display:flex;"><span>                  (<span style="color:#b8860b">:b</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">1</span>)))
</span></span><span style="display:flex;"><span>                  (<span style="color:#b8860b">:n</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">1</span>)))
</span></span><span style="display:flex;"><span>                  (<span style="color:#b8860b">:escape</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>))
</span></span><span style="display:flex;"><span>                  (<span style="color:#b8860b">:close</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>)))))</span></span></code></pre></td></tr></table>
</div>
</div>
<h2 id="a-star-pathfinding">A-star Pathfinding</h2>
<p>Now, we&rsquo;ll want to allow the enemies to move in eight directions. To do this,
we&rsquo;ll need to implement a pathfinding algorithm called &ldquo;A* (A-star).&rdquo; Red Blob Games
as a great <a href="https://www.redblobgames.com/pathfinding/a-star/introduction.html">introduction to A*</a>, as well as an <a href="https://www.redblobgames.com/pathfinding/a-star/implementation.html">implementation guide</a> for
Python, C++, and C#. For my implementation, I used <a href="https://medium.com/@nicholas.w.swift/easy-a-star-pathfinding-7e6689c7f7b2">this article</a> as a guide. I
won&rsquo;t be going very in-depth of how the algorithm works at a high level, so
please refer to the those articles for more information.</p>
<p>First, we&rsquo;re going to use a new library to make use of a priority queue. Update the
dependencies in your ASDF file to match the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#b8860b">:depends-on</span> (<span style="color:#b8860b">#:cl-blt</span> <span style="color:#b8860b">#:queues.priority-queue</span>)
</span></span></code></pre></div><p>If you have you&rsquo;re REPl open, go ahead and load the system with Quicklisp:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#b8860b">ql:quickload</span> <span style="color:#b8860b">:queues.priority-queue</span>)
</span></span></code></pre></div><p>Create a new file &ldquo;pathfinding.lisp&rdquo;. We&rsquo;ll start by creating a &ldquo;node&rdquo; class to
hold the position of the tile, the &ldquo;parent&rdquo; (node that we came from to get to
this node), and the g/h/f variables used in the A* algorithm.</p>
<ul>
<li>&ldquo;h&rdquo; is the estimated distance from the current node to the target location. We
just calculate the distance between the positions using the Pythagorean
Theorem, but other estimations could be used instead.</li>
<li>&ldquo;g&rdquo; is the distance from the starting node to the current node. To calculate
this, we&rsquo;ve decided moving left/right/up/down counts as a distance of 10, and
moving diagonally counts as 14. The &ldquo;g&rdquo; for a given node is the sum of all the
&ldquo;g&rdquo; values of the previous nodes it took to get to the current node.</li>
<li>&ldquo;f&rdquo; is the total cost of the node. It&rsquo;s the sum of the &ldquo;g&rdquo; and &ldquo;h&rdquo; values.</li>
</ul>
<p>We&rsquo;ll also include some helper functions for the class as well.
<code>*all-directions*</code> stores the directions the path can follow from a given tile,
which is in all eight directions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">in-package</span> <span style="color:#b8860b">#:cl-rltut</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defparameter</span> *all-directions*
</span></span><span style="display:flex;"><span>  (<span style="color:#00f">list</span> (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">-1</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">1</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">0</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">0</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">-1</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">1</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">-1</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">1</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">node</span> ()
</span></span><span style="display:flex;"><span>  ((<span style="color:#b8860b">g</span> <span style="color:#b8860b">:initform</span> <span style="color:#666">0</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">node/g</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">h</span> <span style="color:#b8860b">:initform</span> <span style="color:#666">0</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">node/h</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">f</span> <span style="color:#b8860b">:initform</span> <span style="color:#666">0</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">node/f</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">distance-from-parent</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:distance-from-parent</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">node/distance-from-parent</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">parent</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:parent</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">node/parent</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#00a000">position</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:position</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">node/position</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#00a000">print-object</span> ((<span style="color:#b8860b">obj</span> <span style="color:#b8860b">node</span>) <span style="color:#00f">stream</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">print-unreadable-object</span> (<span style="color:#b8860b">obj</span> <span style="color:#00f">stream</span> <span style="color:#b8860b">:type</span> <span style="color:#800">t</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">with-slots</span> (<span style="color:#00a000">position</span> <span style="color:#b8860b">parent</span>) <span style="color:#b8860b">obj</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#00a000">format</span> <span style="color:#00f">stream</span> <span style="color:#b44">&#34;~A, parent ~A&#34;</span> <span style="color:#00a000">position</span> <span style="color:#b8860b">parent</span>))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">node-equal</span> (<span style="color:#b8860b">n1</span> <span style="color:#b8860b">n2</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#b44">&#34;The two nodes are equal if their position slots are equal.&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#00a000">equal</span> (<span style="color:#b8860b">node/position</span> <span style="color:#b8860b">n1</span>) (<span style="color:#b8860b">node/position</span> <span style="color:#b8860b">n2</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">node-compare</span> (<span style="color:#b8860b">n1</span> <span style="color:#b8860b">n2</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#b44">&#34;Compares the F slots on the node, and returns true if n1&#39;s F slot is less than n2&#39;s.&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#00a000">&lt;</span> (<span style="color:#b8860b">node/f</span> <span style="color:#b8860b">n1</span>) (<span style="color:#b8860b">node/f</span> <span style="color:#b8860b">n2</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">find-in-queue</span> (<span style="color:#b8860b">queue</span> <span style="color:#b8860b">n</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#b44">&#34;Finds the node N in the QUEUE by it&#39;s position. If there are multiple nodes
</span></span></span><span style="display:flex;"><span><span style="color:#b44">with the same position, it will return the last one it finds.&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">node</span> <span style="color:#800">nil</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#b8860b">queues:map-queue</span> <span style="color:#00a000">#&#39;</span>(<span style="color:#a2f">lambda</span> (<span style="color:#b8860b">item</span>)
</span></span><span style="display:flex;"><span>                          (<span style="color:#a2f">when</span> (<span style="color:#b8860b">node-equal</span> <span style="color:#b8860b">n</span> <span style="color:#b8860b">item</span>)
</span></span><span style="display:flex;"><span>                            (<span style="color:#a2f">setf</span> <span style="color:#b8860b">node</span> <span style="color:#b8860b">item</span>)))
</span></span><span style="display:flex;"><span>                      <span style="color:#b8860b">queue</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">node</span>))
</span></span></code></pre></div><p>Next, we&rsquo;ll write some helper functions to support the A* algorithm. The
documentation on the functions should describe their functionality.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">create-path</span> (<span style="color:#b8860b">current-node</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#b44">&#34;Given a node, return a list of all parent nodes leading to it.&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">do</span> ((<span style="color:#b8860b">path</span> <span style="color:#800">nil</span>)
</span></span><span style="display:flex;"><span>       (<span style="color:#b8860b">current</span> <span style="color:#b8860b">current-node</span> (<span style="color:#b8860b">node/parent</span> <span style="color:#b8860b">current</span>)))
</span></span><span style="display:flex;"><span>      ((<span style="color:#00f">null</span> <span style="color:#b8860b">current</span>) (<span style="color:#00a000">reverse</span> <span style="color:#b8860b">path</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">setf</span> <span style="color:#b8860b">path</span> (<span style="color:#00a000">append</span> <span style="color:#b8860b">path</span> (<span style="color:#00f">list</span> (<span style="color:#b8860b">node/position</span> <span style="color:#b8860b">current</span>))))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">make-node</span> (<span style="color:#b8860b">parent-node</span> <span style="color:#b8860b">node-x</span> <span style="color:#b8860b">node-y</span> <span style="color:#b8860b">direction-from-parent</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#b44">&#34;Creates a NODE instance with the given PARENT, NODE-X and NODE-Y, and calculates the
</span></span></span><span style="display:flex;"><span><span style="color:#b44">DISTANCE-FROM-PARENT.&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">distance</span> <span style="color:#666">10</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#a2f">and</span> (<span style="color:#00a000">not</span> (<span style="color:#00a000">zerop</span> (<span style="color:#00a000">car</span> <span style="color:#b8860b">direction-from-parent</span>)))
</span></span><span style="display:flex;"><span>             (<span style="color:#00a000">not</span> (<span style="color:#00a000">zerop</span> (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">direction-from-parent</span>))))
</span></span><span style="display:flex;"><span>        (<span style="color:#a2f">setf</span> <span style="color:#b8860b">distance</span> <span style="color:#666">14</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;node</span> <span style="color:#b8860b">:parent</span> <span style="color:#b8860b">parent-node</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#b8860b">:position</span> (<span style="color:#00f">cons</span> <span style="color:#b8860b">node-x</span> <span style="color:#b8860b">node-y</span>)
</span></span><span style="display:flex;"><span>                         <span style="color:#b8860b">:distance-from-parent</span> <span style="color:#b8860b">distance</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">generate-node-cost</span> (<span style="color:#b8860b">child</span> <span style="color:#b8860b">current-node</span> <span style="color:#b8860b">end-node</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#b44">&#34;Calculates and sets the G, H, and F slots on child.&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">g</span> <span style="color:#b8860b">h</span> <span style="color:#b8860b">f</span> <span style="color:#00a000">position</span> <span style="color:#b8860b">distance-from-parent</span>) <span style="color:#b8860b">child</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">setf</span> <span style="color:#b8860b">g</span> (<span style="color:#00a000">+</span> <span style="color:#b8860b">distance-from-parent</span> (<span style="color:#b8860b">node/g</span> <span style="color:#b8860b">current-node</span>))
</span></span><span style="display:flex;"><span>          <span style="color:#b8860b">h</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">expt</span> (<span style="color:#00a000">-</span> (<span style="color:#00a000">car</span> <span style="color:#00a000">position</span>) (<span style="color:#00a000">car</span> (<span style="color:#b8860b">node/position</span> <span style="color:#b8860b">end-node</span>))) <span style="color:#666">2</span>)
</span></span><span style="display:flex;"><span>               (<span style="color:#00a000">expt</span> (<span style="color:#00a000">-</span> (<span style="color:#00a000">cdr</span> <span style="color:#00a000">position</span>) (<span style="color:#00a000">cdr</span> (<span style="color:#b8860b">node/position</span> <span style="color:#b8860b">end-node</span>))) <span style="color:#666">2</span>))
</span></span><span style="display:flex;"><span>          <span style="color:#b8860b">f</span> (<span style="color:#00a000">+</span> <span style="color:#b8860b">g</span> <span style="color:#b8860b">h</span>))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">update-open-queue</span> (<span style="color:#b8860b">open-list</span> <span style="color:#b8860b">child-node</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#b44">&#34;Updates an existing entry in OPEN-LIST if one exists that both matches CHILD-NODE, and
</span></span></span><span style="display:flex;"><span><span style="color:#b44">has a larger G value. If there is no existing entry matching CHILD-NODE, then if pushes
</span></span></span><span style="display:flex;"><span><span style="color:#b44">CHILD-NODE onto OPEN-LIST.&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">existing-child</span> (<span style="color:#b8860b">find-in-queue</span> <span style="color:#b8860b">open-list</span> <span style="color:#b8860b">child-node</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">cond</span> ((<span style="color:#a2f">and</span> <span style="color:#b8860b">existing-child</span> (<span style="color:#00a000">&lt;</span> (<span style="color:#b8860b">node/g</span> <span style="color:#b8860b">child-node</span>) (<span style="color:#b8860b">node/g</span> <span style="color:#b8860b">existing-child</span>)))
</span></span><span style="display:flex;"><span>           (<span style="color:#b8860b">queues:queue-change</span> <span style="color:#b8860b">open-list</span>
</span></span><span style="display:flex;"><span>                                (<span style="color:#b8860b">queues:queue-find</span> <span style="color:#b8860b">open-list</span> <span style="color:#b8860b">existing-child</span>)
</span></span><span style="display:flex;"><span>                                <span style="color:#b8860b">child-node</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#800">t</span>
</span></span><span style="display:flex;"><span>           (<span style="color:#b8860b">queues:qpush</span> <span style="color:#b8860b">open-list</span> <span style="color:#b8860b">child-node</span>)))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">generate-node-children</span> (<span style="color:#b8860b">current-node</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">open-list</span> <span style="color:#b8860b">closed-list</span> <span style="color:#b8860b">end-node</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#b44">&#34;Generates a list of all valid nodes that can be moved to from CURRENT-NODE,
</span></span></span><span style="display:flex;"><span><span style="color:#b44">and adds them to OPEN-QUEUE. A valid node is one that is within the MAP dimensions,
</span></span></span><span style="display:flex;"><span><span style="color:#b44">the tile is not blocking, and the node is not on CLOSED-LIST.&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">dolist</span> (<span style="color:#b8860b">new-position</span> *all-directions*)
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">node-x</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">car</span> (<span style="color:#b8860b">node/position</span> <span style="color:#b8860b">current-node</span>))
</span></span><span style="display:flex;"><span>                     (<span style="color:#00a000">car</span> <span style="color:#b8860b">new-position</span>)))
</span></span><span style="display:flex;"><span>          (<span style="color:#b8860b">node-y</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">cdr</span> (<span style="color:#b8860b">node/position</span> <span style="color:#b8860b">current-node</span>))
</span></span><span style="display:flex;"><span>                     (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">new-position</span>))))
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">unless</span> (<span style="color:#a2f">or</span> (<span style="color:#00a000">&gt;</span> <span style="color:#b8860b">node-x</span> (<span style="color:#00a000">1-</span> (<span style="color:#b8860b">game-map/w</span> <span style="color:#00a000">map</span>)))
</span></span><span style="display:flex;"><span>                  (<span style="color:#00a000">&lt;</span> <span style="color:#b8860b">node-x</span> <span style="color:#666">0</span>)
</span></span><span style="display:flex;"><span>                  (<span style="color:#00a000">&gt;</span> <span style="color:#b8860b">node-y</span> (<span style="color:#00a000">1-</span> (<span style="color:#b8860b">game-map/h</span> <span style="color:#00a000">map</span>)))
</span></span><span style="display:flex;"><span>                  (<span style="color:#00a000">&lt;</span> <span style="color:#b8860b">node-y</span> <span style="color:#666">0</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#a2f">unless</span> (<span style="color:#b8860b">tile/blocked</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) <span style="color:#b8860b">node-x</span> <span style="color:#b8860b">node-y</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">child</span> (<span style="color:#b8860b">make-node</span> <span style="color:#b8860b">current-node</span> <span style="color:#b8860b">node-x</span> <span style="color:#b8860b">node-y</span> <span style="color:#b8860b">new-position</span>)))
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-style:italic">;; child is on the closed list</span>
</span></span><span style="display:flex;"><span>            (<span style="color:#a2f">unless</span> (<span style="color:#00a000">find</span> <span style="color:#b8860b">child</span> <span style="color:#b8860b">closed-list</span> <span style="color:#b8860b">:test</span> <span style="color:#b8860b">&#39;node-equal</span>)
</span></span><span style="display:flex;"><span>              (<span style="color:#b8860b">generate-node-cost</span> <span style="color:#b8860b">child</span> <span style="color:#b8860b">current-node</span> <span style="color:#b8860b">end-node</span>)
</span></span><span style="display:flex;"><span>              (<span style="color:#b8860b">update-open-queue</span> <span style="color:#b8860b">open-list</span> <span style="color:#b8860b">child</span>))))))))
</span></span></code></pre></div><p>Now we can write the main function of the algorithm, <code>astar</code>. It will start by
creating node instances for the start and end nodes, as well as the open-list
and closed-list. The open-list is initially populated with the start-node as the
first node to check. It will then begin a <code>do</code> loop, which pops the next node
off of the open-list queue to process, and continues looping until the path to
the end-node is found, or the open-list queue is empty. The function will return
a list of positions representing the path from start-node to end-node.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">astar</span> (<span style="color:#00a000">map</span> <span style="color:#b8860b">start</span> <span style="color:#b8860b">end</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#b44">&#34;Returns a list of cons cells as a path from the given start to the given end in the given map.&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">start-node</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;node</span> <span style="color:#b8860b">:position</span> <span style="color:#b8860b">start</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#b8860b">end-node</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;node</span> <span style="color:#b8860b">:position</span> <span style="color:#b8860b">end</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#b8860b">open-list</span> (<span style="color:#b8860b">queues:make-queue</span> <span style="color:#b8860b">:priority-queue</span> <span style="color:#b8860b">:compare</span> <span style="color:#00a000">#&#39;</span><span style="color:#b8860b">node-compare</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#b8860b">closed-list</span> <span style="color:#800">nil</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#b8860b">queues:qpush</span> <span style="color:#b8860b">open-list</span> <span style="color:#b8860b">start-node</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">do</span> ((<span style="color:#b8860b">current-node</span> (<span style="color:#b8860b">queues:qpop</span> <span style="color:#b8860b">open-list</span>) (<span style="color:#b8860b">queues:qpop</span> <span style="color:#b8860b">open-list</span>)))
</span></span><span style="display:flex;"><span>        ((<span style="color:#00f">null</span> <span style="color:#b8860b">current-node</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">setf</span> <span style="color:#b8860b">closed-list</span> (<span style="color:#00a000">append</span> <span style="color:#b8860b">closed-list</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">current-node</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#080;font-style:italic">;; found the goal</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">when</span> (<span style="color:#b8860b">node-equal</span> <span style="color:#b8860b">current-node</span> <span style="color:#b8860b">end-node</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#a2f;font-weight:bold">return-from</span> <span style="color:#b8860b">astar</span> (<span style="color:#b8860b">create-path</span> <span style="color:#b8860b">current-node</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      (<span style="color:#b8860b">generate-node-children</span> <span style="color:#b8860b">current-node</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">open-list</span> <span style="color:#b8860b">closed-list</span> <span style="color:#b8860b">end-node</span>))))
</span></span></code></pre></div><p>To make use of this function, modify the <code>move-towards</code> method in entity.lisp
to call <code>astar</code> and move to the second position in the returned path (remember
the first position in the path is where the entity is currently at):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">move-towards</span> ((<span style="color:#b8860b">e</span> <span style="color:#b8860b">entity</span>) <span style="color:#b8860b">target-x</span> <span style="color:#b8860b">target-y</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) <span style="color:#b8860b">e</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">path</span> (<span style="color:#b8860b">astar</span> <span style="color:#00a000">map</span> (<span style="color:#00f">cons</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) (<span style="color:#00f">cons</span> <span style="color:#b8860b">target-x</span> <span style="color:#b8860b">target-y</span>))))
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">when</span> <span style="color:#b8860b">path</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">next-location</span> (<span style="color:#00a000">nth</span> <span style="color:#666">1</span> <span style="color:#b8860b">path</span>)))
</span></span><span style="display:flex;"><span>          (<span style="color:#a2f">unless</span> (<span style="color:#b8860b">blocking-entity-at</span> <span style="color:#b8860b">entities</span> (<span style="color:#00a000">car</span> <span style="color:#b8860b">next-location</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">next-location</span>))
</span></span><span style="display:flex;"><span>            (<span style="color:#b8860b">move</span> <span style="color:#b8860b">e</span> (<span style="color:#00a000">-</span> (<span style="color:#00a000">car</span> <span style="color:#b8860b">next-location</span>) <span style="color:#b8860b">x</span>) (<span style="color:#00a000">-</span> (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">next-location</span>) <span style="color:#b8860b">y</span>))))))))
</span></span></code></pre></div><p>Now if you run the game, you&rsquo;ll see the enemy monsters following the player
around, and that they can now move diagonally.</p>
<h2 id="combat">Combat</h2>
<p>Next we&rsquo;ll start to implement the cambat system. First, add a <code>take-damage</code>
method to the <code>fighter</code> class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defgeneric</span> <span style="color:#b8860b">take-damage</span> (<span style="color:#b8860b">component</span> <span style="color:#b8860b">amount</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">take-damage</span> ((<span style="color:#b8860b">component</span> <span style="color:#b8860b">fighter</span>) <span style="color:#b8860b">amount</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">decf</span> (<span style="color:#b8860b">fighter/hp</span> <span style="color:#b8860b">component</span>) <span style="color:#b8860b">amount</span>))
</span></span></code></pre></div><p>Also add an <code>attack</code> method to the <code>fighter</code> class. It calculate the damage of
the attack by subtracting the defenders defense value from the attackers power.
If the damage is above zero, then it&rsquo;ll call the <code>take-damage</code> function on the defender.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defgeneric</span> <span style="color:#b8860b">attack</span> (<span style="color:#b8860b">component</span> <span style="color:#b8860b">target</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">attack</span> ((<span style="color:#b8860b">component</span> <span style="color:#b8860b">fighter</span>) (<span style="color:#b8860b">target</span> <span style="color:#b8860b">entity</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">damage</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">fighter/power</span> <span style="color:#b8860b">component</span>) (<span style="color:#b8860b">fighter/defense</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">target</span>)))))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">cond</span>
</span></span><span style="display:flex;"><span>      ((<span style="color:#00a000">&gt;</span> <span style="color:#b8860b">damage</span> <span style="color:#666">0</span>)
</span></span><span style="display:flex;"><span>       (<span style="color:#b8860b">take-damage</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">target</span>) <span style="color:#b8860b">damage</span>))
</span></span><span style="display:flex;"><span>       (<span style="color:#00a000">format</span> <span style="color:#800">t</span> <span style="color:#b44">&#34;~A attacks ~A for ~A hit points.~%&#34;</span>
</span></span><span style="display:flex;"><span>               (<span style="color:#b8860b">entity/name</span> (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">component</span>))
</span></span><span style="display:flex;"><span>               (<span style="color:#b8860b">entity/name</span> <span style="color:#b8860b">target</span>)
</span></span><span style="display:flex;"><span>               <span style="color:#b8860b">damage</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#800">t</span>
</span></span><span style="display:flex;"><span>       (<span style="color:#00a000">format</span> <span style="color:#800">t</span> <span style="color:#b44">&#34;~A attacks ~A but does no damage.~%&#34;</span>
</span></span><span style="display:flex;"><span>               (<span style="color:#b8860b">entity/name</span> (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">component</span>))
</span></span><span style="display:flex;"><span>               (<span style="color:#b8860b">entity/name</span> <span style="color:#b8860b">target</span>))))))
</span></span></code></pre></div><p>We can now replace the placeholder messages that we were printing before. In the
cl-rltut.lisp files game loop:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#666">...</span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">unless</span> (<span style="color:#b8860b">blocked-p</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">target</span> (<span style="color:#b8860b">blocking-entity-at</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">cond</span> (<span style="color:#b8860b">target</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>           (<span style="color:#b8860b">attack</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">target</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#800">t</span>
</span></span><span style="display:flex;"><span>           (<span style="color:#b8860b">move</span> <span style="color:#b8860b">player</span> (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))
</span></span><span style="display:flex;"><span>           (<span style="color:#b8860b">fov</span> <span style="color:#00a000">map</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>)))))
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>And the placeholder in components.lisp <code>take-turn</code>:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">take-turn</span> ((<span style="color:#b8860b">component</span> <span style="color:#b8860b">basic-monster</span>) <span style="color:#b8860b">target</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">monster</span> (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">component</span>))
</span></span><span style="display:flex;"><span>         (<span style="color:#b8860b">in-sight</span> (<span style="color:#b8860b">tile/visible</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">monster</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">monster</span>)))))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">when</span> <span style="color:#b8860b">in-sight</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">&gt;=</span> (<span style="color:#b8860b">distance-to</span> <span style="color:#b8860b">monster</span> <span style="color:#b8860b">target</span>) <span style="color:#666">2</span>)
</span></span><span style="display:flex;"><span>             (<span style="color:#b8860b">move-towards</span> <span style="color:#b8860b">monster</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">target</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">target</span>) <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex;"><span>            ((<span style="color:#00a000">&gt;</span> (<span style="color:#b8860b">fighter/hp</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">monster</span>)) <span style="color:#666">0</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>             (<span style="color:#b8860b">attack</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">monster</span>) <span style="color:#b8860b">target</span>))))))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>Now if you run the game, you&rsquo;ll be able to attack enemies, and they will attack
you.</p>
<h2 id="messages-death-and-corpses">Messages, Death, and Corpses</h2>
<p>Before moving on, we need to come up with a better way to handle the messages
we&rsquo;re printing. In the next tutorial, we&rsquo;ll be displaying these messages to the
player in game, rather than just printing them to the console. Instead of
requiring the <code>take-damage</code> and <code>attack</code> functions to be in charge of displaying
those messages, it&rsquo;d be better for them to just return the results of the
actions, and have the message display handled elsewhere. So, we&rsquo;ll modify
<code>take-damage</code> and <code>attack</code> to return a property list of the results:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">take-damage</span> ((<span style="color:#b8860b">component</span> <span style="color:#b8860b">fighter</span>) <span style="color:#b8860b">amount</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">decf</span> (<span style="color:#b8860b">fighter/hp</span> <span style="color:#b8860b">component</span>) <span style="color:#b8860b">amount</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">results</span> <span style="color:#800">nil</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>    (<span style="color:#a2f">when</span> (<span style="color:#00a000">&lt;=</span> (<span style="color:#b8860b">fighter/hp</span> <span style="color:#b8860b">component</span>) <span style="color:#666">0</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>      (<span style="color:#a2f">setf</span> <span style="color:#b8860b">results</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:dead</span> (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">component</span>))))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>    <span style="color:#b8860b">results</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">attack</span> ((<span style="color:#b8860b">component</span> <span style="color:#b8860b">fighter</span>) (<span style="color:#b8860b">target</span> <span style="color:#b8860b">entity</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">results</span> <span style="color:#800">nil</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#b8860b">damage</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">fighter/power</span> <span style="color:#b8860b">component</span>) (<span style="color:#b8860b">fighter/defense</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">target</span>)))))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">cond</span>
</span></span><span style="display:flex;"><span>      ((<span style="color:#00a000">&gt;</span> <span style="color:#b8860b">damage</span> <span style="color:#666">0</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>       (<span style="color:#a2f">setf</span> <span style="color:#b8860b">results</span> (<span style="color:#00a000">append</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:message</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                   (<span style="color:#00a000">format</span> <span style="color:#800">nil</span> <span style="color:#b44">&#34;~A attacks ~A for ~A hit points.~%&#34;</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                           (<span style="color:#b8860b">entity/name</span> (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">component</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                           (<span style="color:#b8860b">entity/name</span> <span style="color:#b8860b">target</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                           <span style="color:#b8860b">damage</span>))
</span></span><span style="display:flex;"><span>                             (<span style="color:#b8860b">take-damage</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">target</span>) <span style="color:#b8860b">damage</span>))))
</span></span><span style="display:flex;"><span>      (<span style="color:#800">t</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>       (<span style="color:#a2f">setf</span> <span style="color:#b8860b">results</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:message</span> (<span style="color:#00a000">format</span> <span style="color:#800">nil</span> <span style="color:#b44">&#34;~A attacks ~A but does no damage.~%&#34;</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                            (<span style="color:#b8860b">entity/name</span> (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">component</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                            (<span style="color:#b8860b">entity/name</span> <span style="color:#b8860b">target</span>))))))))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>Since the <code>attack</code> function is called within the <code>take-turn</code> method on the
<code>component</code> class, we&rsquo;ll want to update that to return the results it receives
from <code>attack</code>:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">take-turn</span> ((<span style="color:#b8860b">component</span> <span style="color:#b8860b">basic-monster</span>) <span style="color:#b8860b">target</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>  (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">results</span> <span style="color:#800">nil</span>)
</span></span><span style="display:flex;"><span>         (<span style="color:#b8860b">monster</span> (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">component</span>))
</span></span><span style="display:flex;"><span>         (<span style="color:#b8860b">in-sight</span> (<span style="color:#b8860b">tile/visible</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">monster</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">monster</span>)))))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">when</span> <span style="color:#b8860b">in-sight</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">&gt;=</span> (<span style="color:#b8860b">distance-to</span> <span style="color:#b8860b">monster</span> <span style="color:#b8860b">target</span>) <span style="color:#666">2</span>)
</span></span><span style="display:flex;"><span>             (<span style="color:#b8860b">move-towards</span> <span style="color:#b8860b">monster</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">target</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">target</span>) <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex;"><span>            ((<span style="color:#00a000">&gt;</span> (<span style="color:#b8860b">fighter/hp</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">monster</span>)) <span style="color:#666">0</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>             (<span style="color:#a2f">setf</span> <span style="color:#b8860b">results</span> (<span style="color:#b8860b">attack</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">monster</span>) <span style="color:#b8860b">target</span>)))))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>    <span style="color:#b8860b">results</span>))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>Now we need to update the game loop to use the results:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">game-tick</span> (<span style="color:#b8860b">player</span> <span style="color:#b8860b">entities</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">game-state</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">type</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">game-state</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#b8860b">render-all</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> *screen-width* *screen-height*)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>  (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">player-turn-results</span> <span style="color:#800">nil</span>)
</span></span><span style="display:flex;"><span>         (<span style="color:#b8860b">action</span> (<span style="color:#b8860b">handle-keys</span>))
</span></span><span style="display:flex;"><span>         (<span style="color:#b8860b">move</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:move</span>))
</span></span><span style="display:flex;"><span>         (<span style="color:#b8860b">exit</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:quit</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">when</span> (<span style="color:#a2f">and</span> <span style="color:#b8860b">move</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">destination-x</span> (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>)))
</span></span><span style="display:flex;"><span>            (<span style="color:#b8860b">destination-y</span> (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))))
</span></span><span style="display:flex;"><span>        (<span style="color:#a2f">unless</span> (<span style="color:#b8860b">blocked-p</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">target</span> (<span style="color:#b8860b">blocking-entity-at</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)))
</span></span><span style="display:flex;"><span>            (<span style="color:#a2f">cond</span> (<span style="color:#b8860b">target</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                   (<span style="color:#a2f">setf</span> <span style="color:#b8860b">player-turn-results</span> (<span style="color:#b8860b">attack</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">target</span>)))
</span></span><span style="display:flex;"><span>                  (<span style="color:#800">t</span>
</span></span><span style="display:flex;"><span>                   (<span style="color:#b8860b">move</span> <span style="color:#b8860b">player</span> (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))
</span></span><span style="display:flex;"><span>                   (<span style="color:#b8860b">fov</span> <span style="color:#00a000">map</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>)))))
</span></span><span style="display:flex;"><span>          (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>))))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">when</span> <span style="color:#b8860b">exit</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/running</span> <span style="color:#b8860b">game-state</span>) <span style="color:#800">nil</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">message</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:message</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>          (<span style="color:#b8860b">dead-entity</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:dead</span>)))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>      (<span style="color:#a2f">when</span> <span style="color:#b8860b">message</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>        (<span style="color:#00a000">format</span> <span style="color:#800">t</span> <span style="color:#b8860b">message</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>      (<span style="color:#a2f">when</span> <span style="color:#b8860b">dead-entity</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>        <span style="color:#080;font-style:italic">;; we&#39;ll get to this next</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>        ))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">dolist</span> (<span style="color:#b8860b">entity</span> (<span style="color:#00a000">remove-if-not</span> <span style="color:#00a000">#&#39;</span><span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>        (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">enemy-turn-results</span> (<span style="color:#b8860b">take-turn</span> (<span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">entity</span>) <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>               (<span style="color:#b8860b">message</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">enemy-turn-results</span> <span style="color:#b8860b">:message</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>               (<span style="color:#b8860b">dead-entity</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">enemy-turn-results</span> <span style="color:#b8860b">:dead</span>)))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>          (<span style="color:#a2f">when</span> <span style="color:#b8860b">message</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>            (<span style="color:#00a000">format</span> <span style="color:#800">t</span> <span style="color:#b8860b">message</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>          (<span style="color:#a2f">when</span> <span style="color:#b8860b">dead-entity</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>            <span style="color:#080;font-style:italic">;; we&#39;ll get to this next</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>            )))
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#b8860b">game-state</span>)</span></span></code></pre></td></tr></table>
</div>
</div>
<p>With that out of the way, we can work on handling the death of players and
monsters. Create a new file <code>death-functions.lisp</code>, with the <code>kill-player</code> and
<code>kill-monster</code> functions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">in-package</span> <span style="color:#b8860b">#:cl-rltut</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">kill-player</span> (<span style="color:#b8860b">player</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">entity/char</span> <span style="color:#b8860b">player</span>) <span style="color:#b44">#\%</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#b8860b">entity/color</span> <span style="color:#b8860b">player</span>) (<span style="color:#b8860b">blt:red</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  (<span style="color:#00a000">values</span> <span style="color:#b44">&#34;You died!&#34;</span> <span style="color:#b8860b">:player-dead</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">kill-monster</span> (<span style="color:#b8860b">monster</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">with-slots</span> (<span style="color:#00a000">char</span> <span style="color:#b8860b">color</span> <span style="color:#b8860b">blocks</span> <span style="color:#b8860b">ai</span> <span style="color:#b8860b">name</span>) <span style="color:#b8860b">monster</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">message</span> (<span style="color:#00a000">format</span> <span style="color:#800">nil</span> <span style="color:#b44">&#34;~A is dead!~%&#34;</span> <span style="color:#b8860b">name</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">setf</span> <span style="color:#00a000">char</span> <span style="color:#b44">#\%</span>
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">color</span> (<span style="color:#b8860b">blt:red</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">blocks</span> <span style="color:#800">nil</span>
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">ai</span> <span style="color:#800">nil</span>
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">name</span> (<span style="color:#00a000">format</span> <span style="color:#800">nil</span> <span style="color:#b44">&#34;remains of ~A&#34;</span> <span style="color:#b8860b">name</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#b8860b">message</span>)))
</span></span></code></pre></div><p>Now update the placeholders in cl-rltut.lisp to call these functions. When the
player is killed, we set the game state to :player-dead and break out of
<code>game-tick=</code>. The game will continue to run, and the <code>game-tick</code> function will
continue to be called, but with that game-state no enemy turns or player turn
will happen. The only option will be to quit the game.</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">message</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:message</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#b8860b">dead-entity</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:dead</span>)))
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">when</span> <span style="color:#b8860b">message</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#00a000">format</span> <span style="color:#800">t</span> <span style="color:#b8860b">message</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">when</span> <span style="color:#b8860b">dead-entity</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>    (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">equal</span> <span style="color:#b8860b">dead-entity</span> <span style="color:#b8860b">player</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>           (<span style="color:#a2f">setf</span> (<span style="color:#00a000">values</span> <span style="color:#b8860b">message</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                 (<span style="color:#b8860b">kill-player</span> <span style="color:#b8860b">dead-entity</span>)))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>          (<span style="color:#800">t</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>           (<span style="color:#a2f">setf</span> <span style="color:#b8860b">message</span> (<span style="color:#b8860b">kill-monster</span> <span style="color:#b8860b">dead-entity</span>))))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>    ((<span style="color:#00a000">format</span> <span style="color:#800">t</span> <span style="color:#b44">&#34;~&amp;  ~%&#34;</span>) <span style="color:#800">t</span> <span style="color:#b8860b">message</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">dolist</span> (<span style="color:#b8860b">entity</span> (<span style="color:#00a000">remove-if-not</span> <span style="color:#00a000">#&#39;</span><span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">enemy-turn-results</span> (<span style="color:#b8860b">take-turn</span> (<span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">entity</span>) <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">entities</span>))
</span></span><span style="display:flex;"><span>           (<span style="color:#b8860b">message</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">enemy-turn-results</span> <span style="color:#b8860b">:message</span>))
</span></span><span style="display:flex;"><span>           (<span style="color:#b8860b">dead-entity</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">enemy-turn-results</span> <span style="color:#b8860b">:dead</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">when</span> <span style="color:#b8860b">message</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#00a000">format</span> <span style="color:#800">t</span> <span style="color:#b8860b">message</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">when</span> <span style="color:#b8860b">dead-entity</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>        (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">equal</span> <span style="color:#b8860b">dead-entity</span> <span style="color:#b8860b">player</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>               (<span style="color:#a2f">setf</span> (<span style="color:#00a000">values</span> <span style="color:#b8860b">message</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                     (<span style="color:#b8860b">kill-player</span> <span style="color:#b8860b">dead-entity</span>)))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>              (<span style="color:#800">t</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>               (<span style="color:#a2f">setf</span> <span style="color:#b8860b">message</span> (<span style="color:#b8860b">kill-monster</span> <span style="color:#b8860b">dead-entity</span>))))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>        ((<span style="color:#00a000">format</span> <span style="color:#800">t</span> <span style="color:#b44">&#34;~&amp;  ~%&#34;</span>) <span style="color:#800">t</span> <span style="color:#b8860b">message</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>        (<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-dead</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>          (<span style="color:#a2f;font-weight:bold">return-from</span> <span style="color:#b8860b">game-tick</span> <span style="color:#b8860b">game-state</span>)))))
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>Now if you run the game, you can kill enemies and they will turn into corpses.
If you die, you will no longer be able to move and must exit the game.
<img src="/cl-rltut/enemy-corpses.png" alt=""></p>
<h2 id="displaying-player-health">Displaying Player Health</h2>
<p>One problem with the combat system is the player has no way of knowing how much
health they have remaining. So we&rsquo;ll display the player&rsquo;s health in the game.
Update the render-all function to accept the player as a parameter, and display
their health:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex; background-color:#dfdfdf"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">render-all</span> (<span style="color:#b8860b">entities</span> <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">screen-width</span> <span style="color:#b8860b">screen-height</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">ignore</span> <span style="color:#b8860b">screen-width</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#b8860b">blt:clear</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">y</span> *map-height*)
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">x</span> *map-width*)
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">tile</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>))
</span></span><span style="display:flex;"><span>             (<span style="color:#b8860b">wall</span> (<span style="color:#b8860b">tile/block-sight</span> <span style="color:#b8860b">tile</span>))
</span></span><span style="display:flex;"><span>             (<span style="color:#b8860b">visible</span> (<span style="color:#b8860b">tile/visible</span> <span style="color:#b8860b">tile</span>))
</span></span><span style="display:flex;"><span>             (<span style="color:#b8860b">explored</span> (<span style="color:#b8860b">tile/explored</span> <span style="color:#b8860b">tile</span>)))
</span></span><span style="display:flex;"><span>        (<span style="color:#a2f">cond</span> (<span style="color:#b8860b">visible</span>
</span></span><span style="display:flex;"><span>               (<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b8860b">wall</span>
</span></span><span style="display:flex;"><span>                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:light-wall</span>))
</span></span><span style="display:flex;"><span>                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:light-ground</span>)))
</span></span><span style="display:flex;"><span>               (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:cell-char</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) <span style="color:#b44">#\Space</span>))
</span></span><span style="display:flex;"><span>              (<span style="color:#b8860b">explored</span>
</span></span><span style="display:flex;"><span>               (<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b8860b">wall</span>
</span></span><span style="display:flex;"><span>                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:dark-wall</span>))
</span></span><span style="display:flex;"><span>                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:dark-ground</span>)))
</span></span><span style="display:flex;"><span>               (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:cell-char</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) <span style="color:#b44">#\Space</span>))))))
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#b8860b">blt:black</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#b8860b">blt:color</span>) (<span style="color:#b8860b">blt:white</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>  (<span style="color:#b8860b">blt:print</span> <span style="color:#666">1</span> (<span style="color:#00a000">1-</span> <span style="color:#b8860b">screen-height</span>) (<span style="color:#00a000">format</span> <span style="color:#800">nil</span> <span style="color:#b44">&#34;HP: ~2d/~2d&#34;</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                          (<span style="color:#b8860b">fighter/hp</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">player</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                          (<span style="color:#b8860b">fighter/max-hp</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">player</span>))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  (<span style="color:#b8860b">blt:refresh</span>))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>If you run the game now, you should see the players health and maximum health
displayed in the lower left corner of the screen:
<img src="/cl-rltut/player-health-display.png" alt=""></p>
<h2 id="rendering-order">Rendering Order</h2>
<p>One issue we have now is when you walk over a corpse, the corpse is rendered on
top of the player. The last thing we&rsquo;ll do in this post is fix that. Let&rsquo;s start
by creating a new file called <code>rendering.lisp</code> and moving the <code>render-all</code>
function there. Then, define a variable to hold a property list with the order
to render entities (we&rsquo;ll only use <code>:corpse</code> and <code>:actor</code> now until we add items):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defparameter</span> *render-order*
</span></span><span style="display:flex;"><span>  <span style="color:#666">&#39;</span>(<span style="color:#b8860b">:corpse</span> <span style="color:#666">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">:item</span> <span style="color:#666">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#b8860b">:actor</span> <span style="color:#666">3</span>))
</span></span></code></pre></div><p>Then, we&rsquo;ll need to store the render-order on the <code>entity</code> class. We&rsquo;ll default
it to corpse if it&rsquo;s not supplied when creating an <code>entity</code> instance:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">entity</span> ()
</span></span><span style="display:flex;"><span>  ((<span style="color:#b8860b">name</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:name</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/name</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">x</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/x</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">y</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/y</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#00a000">char</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:char</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/char</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">color</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:color</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/color</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">blocks</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:blocks</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/blocks</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>   (<span style="color:#b8860b">render-order</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:render-order</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/render-order</span> <span style="color:#b8860b">:initform</span> <span style="color:#b8860b">:corpse</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">fighter</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#b8860b">ai</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:ai</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>Now, update all the places that an <code>entity</code> is initialized, to pass in the
render order. In <code>cl-rltut.lisp</code> <code>main</code> function, for the player:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#b8860b">player</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Player&#34;</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#b8860b">:x</span> (<span style="color:#00a000">/</span> *screen-width* <span style="color:#666">2</span>)
</span></span><span style="display:flex;"><span>                       <span style="color:#b8860b">:y</span> (<span style="color:#00a000">/</span> *screen-height* <span style="color:#666">2</span>)
</span></span><span style="display:flex;"><span>                       <span style="color:#b8860b">:char</span> <span style="color:#b44">#\@</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:white</span>)
</span></span><span style="display:flex;"><span>                       <span style="color:#b8860b">:blocks</span> <span style="color:#800">t</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                       <span style="color:#b8860b">:render-order</span> <span style="color:#b8860b">:actor</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">fighter-component</span>))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>And in the <code>place-entities</code> function in <code>game-map.lisp</code>, for each monster:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">cond</span> ((<span style="color:#00a000">&lt;</span> (<span style="color:#00a000">random</span> <span style="color:#666">100</span>) <span style="color:#666">80</span>)
</span></span><span style="display:flex;"><span>       (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">fighter-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;fighter</span> <span style="color:#b8860b">:hp</span> <span style="color:#666">10</span> <span style="color:#b8860b">:defense</span> <span style="color:#666">0</span> <span style="color:#b8860b">:power</span> <span style="color:#666">3</span>))
</span></span><span style="display:flex;"><span>              (<span style="color:#b8860b">ai-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;basic-monster</span>))
</span></span><span style="display:flex;"><span>              (<span style="color:#b8860b">orc</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span> <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Orc&#34;</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:green</span>) <span style="color:#b8860b">:char</span> <span style="color:#b44">#\o</span> <span style="color:#b8860b">:blocks</span> <span style="color:#800">t</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                          <span style="color:#b8860b">:render-order</span> <span style="color:#b8860b">:actor</span>
</span></span><span style="display:flex;"><span>                                          <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">fighter-component</span> <span style="color:#b8860b">:ai</span> <span style="color:#b8860b">ai-component</span>)))
</span></span><span style="display:flex;"><span>         (<span style="color:#00a000">nconc</span> <span style="color:#b8860b">entities</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">orc</span>))))
</span></span><span style="display:flex;"><span>      (<span style="color:#800">t</span>
</span></span><span style="display:flex;"><span>       (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">fighter-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;fighter</span> <span style="color:#b8860b">:hp</span> <span style="color:#666">16</span> <span style="color:#b8860b">:defense</span> <span style="color:#666">1</span> <span style="color:#b8860b">:power</span> <span style="color:#666">4</span>))
</span></span><span style="display:flex;"><span>              (<span style="color:#b8860b">ai-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;basic-monster</span>))
</span></span><span style="display:flex;"><span>              (<span style="color:#b8860b">troll</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span> <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Troll&#34;</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:yellow</span>) <span style="color:#b8860b">:char</span> <span style="color:#b44">#\T</span> <span style="color:#b8860b">:blocks</span> <span style="color:#800">t</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>                                            <span style="color:#b8860b">:render-order</span> <span style="color:#b8860b">:actor</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">fighter-component</span> <span style="color:#b8860b">:ai</span> <span style="color:#b8860b">ai-component</span>)))
</span></span><span style="display:flex;"><span>         (<span style="color:#00a000">nconc</span> <span style="color:#b8860b">entities</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">troll</span>)))))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>We&rsquo;ll also need to change an entities render order to <code>:corpse</code> when they die.
In the <code>kill-monster</code> function in <code>death-functions.lisp</code>:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">kill-monster</span> (<span style="color:#b8860b">monster</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>  (<span style="color:#a2f">with-slots</span> (<span style="color:#00a000">char</span> <span style="color:#b8860b">color</span> <span style="color:#b8860b">blocks</span> <span style="color:#b8860b">ai</span> <span style="color:#b8860b">name</span> <span style="color:#b8860b">render-order</span>) <span style="color:#b8860b">monster</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">message</span> (<span style="color:#00a000">format</span> <span style="color:#800">nil</span> <span style="color:#b44">&#34;~A is dead!~%&#34;</span> <span style="color:#b8860b">name</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f">setf</span> <span style="color:#00a000">char</span> <span style="color:#b44">#\%</span>
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">color</span> (<span style="color:#b8860b">blt:red</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">blocks</span> <span style="color:#800">nil</span>
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">ai</span> <span style="color:#800">nil</span>
</span></span><span style="display:flex;"><span>            <span style="color:#b8860b">name</span> (<span style="color:#00a000">format</span> <span style="color:#800">nil</span> <span style="color:#b44">&#34;remains of ~A&#34;</span> <span style="color:#b8860b">name</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>            <span style="color:#b8860b">render-order</span> <span style="color:#b8860b">:corpse</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#b8860b">message</span>)))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>Finally, we need to sort the entities by their render order before rendering
them. In <code>rendering.lisp</code> update the <code>render-all</code> function to sort the entities:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></span><span style="background-color:#dfdfdf"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-lisp" data-lang="lisp"><span style="display:flex; background-color:#dfdfdf"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">render-order-compare</span> (<span style="color:#b8860b">entity-1</span> <span style="color:#b8860b">entity-2</span>)
</span></span><span style="display:flex; background-color:#dfdfdf"><span>  (<span style="color:#00a000">&lt;</span> (<span style="color:#00a000">getf</span> *render-order* (<span style="color:#b8860b">entity/render-order</span> <span style="color:#b8860b">entity-1</span>))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>     (<span style="color:#00a000">getf</span> *render-order* (<span style="color:#b8860b">entity/render-order</span> <span style="color:#b8860b">entity-2</span>))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a2f">defun</span> <span style="color:#b8860b">render-all</span> (<span style="color:#b8860b">entities</span> <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">screen-width</span> <span style="color:#b8860b">screen-height</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">ignore</span> <span style="color:#b8860b">screen-width</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#b8860b">blt:clear</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">y</span> *map-height*)
</span></span><span style="display:flex;"><span>    (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">x</span> *map-width*)
</span></span><span style="display:flex;"><span>      (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">tile</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>))
</span></span><span style="display:flex;"><span>             (<span style="color:#b8860b">wall</span> (<span style="color:#b8860b">tile/block-sight</span> <span style="color:#b8860b">tile</span>))
</span></span><span style="display:flex;"><span>             (<span style="color:#b8860b">visible</span> (<span style="color:#b8860b">tile/visible</span> <span style="color:#b8860b">tile</span>))
</span></span><span style="display:flex;"><span>             (<span style="color:#b8860b">explored</span> (<span style="color:#b8860b">tile/explored</span> <span style="color:#b8860b">tile</span>)))
</span></span><span style="display:flex;"><span>        (<span style="color:#a2f">cond</span> (<span style="color:#b8860b">visible</span>
</span></span><span style="display:flex;"><span>               (<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b8860b">wall</span>
</span></span><span style="display:flex;"><span>                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:light-wall</span>))
</span></span><span style="display:flex;"><span>                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:light-ground</span>)))
</span></span><span style="display:flex;"><span>               (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:cell-char</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) <span style="color:#b44">#\Space</span>))
</span></span><span style="display:flex;"><span>              (<span style="color:#b8860b">explored</span>
</span></span><span style="display:flex;"><span>               (<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b8860b">wall</span>
</span></span><span style="display:flex;"><span>                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:dark-wall</span>))
</span></span><span style="display:flex;"><span>                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:dark-ground</span>)))
</span></span><span style="display:flex;"><span>               (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:cell-char</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) <span style="color:#b44">#\Space</span>))))))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>  (<span style="color:#00a000">mapc</span> <span style="color:#00a000">#&#39;</span>(<span style="color:#a2f">lambda</span> (<span style="color:#b8860b">entity</span>) (<span style="color:#b8860b">draw</span> <span style="color:#b8860b">entity</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>)))
</span></span><span style="display:flex; background-color:#dfdfdf"><span>        (<span style="color:#00a000">sort</span> <span style="color:#b8860b">entities</span> <span style="color:#00a000">#&#39;</span><span style="color:#b8860b">render-order-compare</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#b8860b">blt:black</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#b8860b">blt:color</span>) (<span style="color:#b8860b">blt:white</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#b8860b">blt:print</span> <span style="color:#666">1</span> (<span style="color:#00a000">1-</span> <span style="color:#b8860b">screen-height</span>) (<span style="color:#00a000">format</span> <span style="color:#800">nil</span> <span style="color:#b44">&#34;HP: ~2d/~2d&#34;</span>
</span></span><span style="display:flex;"><span>                                          (<span style="color:#b8860b">fighter/hp</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">player</span>))
</span></span><span style="display:flex;"><span>                                          (<span style="color:#b8860b">fighter/max-hp</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">player</span>))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  (<span style="color:#b8860b">blt:refresh</span>))</span></span></code></pre></td></tr></table>
</div>
</div>
<p>Now when you run the game and walk over a corpse, the player will be rendered on top.</p>
<h2 id="conclusion">Conclusion</h2>
<p>That was a long post, but there is now a working combat system. In the next post
we&rsquo;ll be focusing on creating the user interface so that we can display messages
within the game, rather than printing them to the REPL.</p>
<p>You can find the current state of the code on <a href="https://github.com/nwforrer/cl-rltut/tree/part-6">Github</a>. The list of changes since
the previous tutorial can be found at
<a href="https://github.com/nwforrer/cl-rltut/compare/part-5...part-6">https://github.com/nwforrer/cl-rltut/compare/part-5...part-6</a>.</p>
<p>If you run into any issues, or have questions/feedback, please open an issue on this
blogs <a href="https://github.com/nwforrer/blog/issues">GitHub repository</a>.</p>

		</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = '';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div><a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148797548-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
