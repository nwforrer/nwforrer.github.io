<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Roguelike tutorial for Common Lisp - Part 8 - Items and inventory - nick forrer</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Roguelike tutorial for Common Lisp - Part 8 - Items and inventory" />
<meta property="og:description" content="This tutorial series is based on the Python Roguelike Tutorial. This will be covering Part 8 of that tutorial.
In this part, we will add items to the game, as well as an inventory system to interact with the items. For now, we will only be adding one item, a healing potion, but we will be adding more items in the future.
Placing items To start, we will update the map generation code to start placing healing potions." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nwforrer.github.io/posts/roguelike-tutorial-part8/" />
<meta property="article:published_time" content="2020-02-23T12:00:00-05:00" />
<meta property="article:modified_time" content="2020-02-23T12:00:00-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Roguelike tutorial for Common Lisp - Part 8 - Items and inventory"/>
<meta name="twitter:description" content="This tutorial series is based on the Python Roguelike Tutorial. This will be covering Part 8 of that tutorial.
In this part, we will add items to the game, as well as an inventory system to interact with the items. For now, we will only be adding one item, a healing potion, but we will be adding more items in the future.
Placing items To start, we will update the map generation code to start placing healing potions."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://nwforrer.github.io/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://nwforrer.github.io/css/main.css" /><script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script><script src="https://nwforrer.github.io/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title">nick forrer</h1>
	<div class="site-description"><h2>Game development and Lisp related posts</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/nwforrer" title="Github"><i data-feather="github"></i></a><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/categories/roguelike-tutorial">Roguelike Tutorials</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Roguelike tutorial for Common Lisp - Part 8 - Items and inventory</h1>
			<div class="meta">Posted at &mdash; Feb 23, 2020</div>
		</div>

		<div class="markdown">
			

<p>This tutorial series is based on the <a href="http://rogueliketutorials.com">Python Roguelike Tutorial</a>. This will be
covering <a href="http://rogueliketutorials.com/tutorials/tcod/part-8/">Part 8</a> of that tutorial.</p>

<p>In this part, we will add items to the game, as well as an inventory system to
interact with the items. For now, we will only be adding one item, a healing
potion, but we will be adding more items in the future.</p>

<h2 id="placing-items">Placing items</h2>

<p>To start, we will update the map generation code to start placing healing
potions. Create a new function &ldquo;place-items&rdquo; that will place items in random
positions within a room. Then, update the &ldquo;place-entities&rdquo; method to take in a new parameter for the
max items allowed per room, and to call the new &ldquo;place-items&rdquo; function with a
random number of items to place. We&rsquo;ll also separate out a new function for
&ldquo;place-monsters&rdquo; so that the &ldquo;place-entities&rdquo; function doesn&rsquo;t get too large.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">place-monsters</span> (<span style="color:#00a000">room</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">num-monsters</span>)
  (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">monster-index</span> <span style="color:#b8860b">num-monsters</span>)
    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">x</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">rect/x2</span> <span style="color:#00a000">room</span>) (<span style="color:#b8860b">rect/x1</span> <span style="color:#00a000">room</span>) <span style="color:#666">1</span>) <span style="color:#666">2</span>))) (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/x1</span> <span style="color:#00a000">room</span>))))
          (<span style="color:#b8860b">y</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">rect/y2</span> <span style="color:#00a000">room</span>) (<span style="color:#b8860b">rect/y1</span> <span style="color:#00a000">room</span>) <span style="color:#666">1</span>) <span style="color:#666">2</span>))) (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/y1</span> <span style="color:#00a000">room</span>)))))
      (<span style="color:#a2f">unless</span> (<span style="color:#b8860b">entity-at</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>)
        (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">&lt;</span> (<span style="color:#00a000">random</span> <span style="color:#666">100</span>) <span style="color:#666">80</span>)
               (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">fighter-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;fighter</span> <span style="color:#b8860b">:hp</span> <span style="color:#666">10</span> <span style="color:#b8860b">:defense</span> <span style="color:#666">0</span> <span style="color:#b8860b">:power</span> <span style="color:#666">3</span>))
                      (<span style="color:#b8860b">ai-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;basic-monster</span>))
                      (<span style="color:#b8860b">orc</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span> <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Orc&#34;</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:green</span>) <span style="color:#b8860b">:char</span> <span style="color:#b44">#\o</span> <span style="color:#b8860b">:blocks</span> <span style="color:#800">t</span>
                                                  <span style="color:#b8860b">:render-order</span> <span style="color:#b8860b">:actor</span>
                                                  <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">fighter-component</span> <span style="color:#b8860b">:ai</span> <span style="color:#b8860b">ai-component</span>)))
                 (<span style="color:#00a000">nconc</span> <span style="color:#b8860b">entities</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">orc</span>))))
              (<span style="color:#800">t</span>
               (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">fighter-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;fighter</span> <span style="color:#b8860b">:hp</span> <span style="color:#666">16</span> <span style="color:#b8860b">:defense</span> <span style="color:#666">1</span> <span style="color:#b8860b">:power</span> <span style="color:#666">4</span>))
                      (<span style="color:#b8860b">ai-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;basic-monster</span>))
                      (<span style="color:#b8860b">troll</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span> <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Troll&#34;</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:yellow</span>) <span style="color:#b8860b">:char</span> <span style="color:#b44">#\T</span> <span style="color:#b8860b">:blocks</span> <span style="color:#800">t</span>
                                                    <span style="color:#b8860b">:render-order</span> <span style="color:#b8860b">:actor</span>
                                                    <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">fighter-component</span> <span style="color:#b8860b">:ai</span> <span style="color:#b8860b">ai-component</span>)))
                 (<span style="color:#00a000">nconc</span> <span style="color:#b8860b">entities</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">troll</span>)))))))))

(<span style="color:#a2f">defun</span> <span style="color:#b8860b">place-items</span> (<span style="color:#00a000">room</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">num-items</span>)
  (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">item-index</span> <span style="color:#b8860b">num-items</span>)
    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">x</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">rect/x2</span> <span style="color:#00a000">room</span>) (<span style="color:#b8860b">rect/x1</span> <span style="color:#00a000">room</span>) <span style="color:#666">1</span>) <span style="color:#666">2</span>))) (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/x1</span> <span style="color:#00a000">room</span>))))
          (<span style="color:#b8860b">y</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">rect/y2</span> <span style="color:#00a000">room</span>) (<span style="color:#b8860b">rect/y1</span> <span style="color:#00a000">room</span>) <span style="color:#666">1</span>) <span style="color:#666">2</span>))) (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/y1</span> <span style="color:#00a000">room</span>)))))
      (<span style="color:#a2f">unless</span> (<span style="color:#b8860b">entity-at</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>)
        (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">potion</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span> <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Healing Potion&#34;</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:purple</span>)
                                           <span style="color:#b8860b">:char</span> <span style="color:#b44">#\!</span> <span style="color:#b8860b">:blocks</span> <span style="color:#800">nil</span> <span style="color:#b8860b">:render-order</span> <span style="color:#b8860b">:item</span>)))
          (<span style="color:#00a000">nconc</span> <span style="color:#b8860b">entities</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">potion</span>)))))))

(<span style="color:#a2f">defgeneric</span> <span style="color:#b8860b">place-entities</span> (<span style="color:#00a000">map</span> <span style="color:#00a000">room</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">max-enemies-per-room</span> <span style="color:#b8860b">max-items-per-room</span>))

(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">place-entities</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>) (<span style="color:#00a000">room</span> <span style="color:#b8860b">rect</span>) <span style="color:#b8860b">entities</span> <span style="color:#b8860b">max-enemies-per-room</span> <span style="color:#b8860b">max-items-per-room</span>)
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">num-monsters</span> (<span style="color:#00a000">random</span> <span style="color:#b8860b">max-enemies-per-room</span>))
        (<span style="color:#b8860b">num-items</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">1+</span> <span style="color:#b8860b">max-items-per-room</span>))))
    (<span style="color:#b8860b">place-monsters</span> <span style="color:#00a000">room</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">num-monsters</span>)
    (<span style="color:#b8860b">place-items</span> <span style="color:#00a000">room</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">num-items</span>)))</code></pre></div>
<p>Now, in the &ldquo;make-map&rdquo; method, add a new &ldquo;max-items-per-room&rdquo; parameter, and
pass it through to the &ldquo;place-entities&rdquo; method.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defgeneric</span> <span style="color:#b8860b">make-map</span> (<span style="color:#00a000">map</span> <span style="color:#b8860b">max-rooms</span> <span style="color:#b8860b">room-min-size</span> <span style="color:#b8860b">room-max-size</span> <span style="color:#b8860b">map-width</span> <span style="color:#b8860b">map-height</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">max-enemies-per-room</span> <span style="color:#b8860b">max-items-per-room</span>))
(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">make-map</span> ((<span style="color:#00a000">map</span> <span style="color:#b8860b">game-map</span>) <span style="color:#b8860b">max-rooms</span> <span style="color:#b8860b">room-min-size</span> <span style="color:#b8860b">room-max-size</span> <span style="color:#b8860b">map-width</span> <span style="color:#b8860b">map-height</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">max-enemies-per-room</span> <span style="color:#b8860b">max-items-per-room</span>)
    <span style="color:#666">...</span>
    (<span style="color:#b8860b">place-entities</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">new-room</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">max-enemies-per-room</span> <span style="color:#b8860b">max-items-per-room</span>)
    <span style="color:#666">...</span>)</code></pre></div>
<p>In the main &ldquo;cl-rltut.lisp&rdquo; file, add the max items variable, and update the
call to &ldquo;make-map&rdquo; to pass the variable through.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defparameter</span> *max-items-per-room* <span style="color:#666">2</span>)

(<span style="color:#b8860b">make-map</span> <span style="color:#00a000">map</span> *max-rooms* *room-min-size* *room-max-size* *map-width* *map-height* <span style="color:#b8860b">player</span> <span style="color:#b8860b">entities</span> *max-enemies-per-room* *max-items-per-room*)</code></pre></div>
<p>Now, if you run the game, you should see some health potions placed throughout
the map. However, you won&rsquo;t be able to interact with them, which is what we&rsquo;ll
be working on now.</p>

<figure>
    <img src="/cl-rltut/items.png"/> 
</figure>


<h2 id="picking-up-items">Picking up items</h2>

<p>Now, we will create a way to pickup the items we&rsquo;ve placed on the map. The first
step will be to create an inventory to hold all of the items we pick up. In the
&ldquo;components.lisp&rdquo; file, create a new &ldquo;inventory&rdquo; class:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">inventory</span> (<span style="color:#b8860b">component</span>)
  ((<span style="color:#b8860b">capacity</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:capacity</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">inventory/capacity</span>)
   (<span style="color:#b8860b">items</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:items</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">inventory/items</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)))</code></pre></div>
<p>Next, we need a way to tell which entities can be picked up and placed in the
inventory. For that, create an &ldquo;item&rdquo; component, which will be added to any
entities that can be pickup up. For now, it won&rsquo;t hold any additional slots, but
some will be added later.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">item</span> (<span style="color:#b8860b">component</span>))</code></pre></div>
<p>Now, we need to add slots for these two new components to the entity class:</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">entity</span> ()
  ((<span style="color:#b8860b">name</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:name</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/name</span>)
   (<span style="color:#b8860b">x</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/x</span>)
   (<span style="color:#b8860b">y</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/y</span>)
   (<span style="color:#00a000">char</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:char</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/char</span>)
   (<span style="color:#b8860b">color</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:color</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/color</span>)
   (<span style="color:#b8860b">blocks</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:blocks</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/blocks</span>)
   (<span style="color:#b8860b">render-order</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:render-order</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/render-order</span> <span style="color:#b8860b">:initform</span> <span style="color:#b8860b">:corpse</span>)
   (<span style="color:#b8860b">fighter</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)
   (<span style="color:#b8860b">ai</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:ai</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)
<span style="display:block;width:100%;background-color:#dfdfdf">   (<span style="color:#b8860b">item</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:item</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/item</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">   (<span style="color:#b8860b">inventory</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:inventory</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)))</span></code></pre></td></tr></table>
</div>
</div>

<p>Now, make sure to add an inventory component to the player, and an item
component to the healing potions.</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">main</span> (<span style="color:#666">...</span>)
<span style="color:#666">...</span>
<span style="display:block;width:100%;background-color:#dfdfdf">(<span style="color:#b8860b">inventory-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;inventory</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">                                               <span style="color:#b8860b">:capacity</span> <span style="color:#666">26</span>))
</span>(<span style="color:#b8860b">player</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span>
                                  <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Player&#34;</span>
                                  <span style="color:#b8860b">:x</span> (<span style="color:#00a000">/</span> *screen-width* <span style="color:#666">2</span>)
                                  <span style="color:#b8860b">:y</span> (<span style="color:#00a000">/</span> *screen-height* <span style="color:#666">2</span>)
                                  <span style="color:#b8860b">:char</span> <span style="color:#b44">#\@</span>
                                  <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:white</span>)
                                  <span style="color:#b8860b">:blocks</span> <span style="color:#800">t</span>
                                  <span style="color:#b8860b">:render-order</span> <span style="color:#b8860b">:actor</span>
<span style="display:block;width:100%;background-color:#dfdfdf">                                  <span style="color:#b8860b">:fighter</span> <span style="color:#b8860b">fighter-component</span>
</span>                                  <span style="color:#b8860b">:inventory</span> <span style="color:#b8860b">inventory-component</span>))
<span style="color:#666">...</span>)

(<span style="color:#a2f">defun</span> <span style="color:#b8860b">place-items</span> (<span style="color:#00a000">room</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">num-items</span>)
  (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">item-index</span> <span style="color:#b8860b">num-items</span>)
    (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">x</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">rect/x2</span> <span style="color:#00a000">room</span>) (<span style="color:#b8860b">rect/x1</span> <span style="color:#00a000">room</span>) <span style="color:#666">1</span>) <span style="color:#666">2</span>))) (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/x1</span> <span style="color:#00a000">room</span>))))
           (<span style="color:#b8860b">y</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">rect/y2</span> <span style="color:#00a000">room</span>) (<span style="color:#b8860b">rect/y1</span> <span style="color:#00a000">room</span>) <span style="color:#666">1</span>) <span style="color:#666">2</span>))) (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/y1</span> <span style="color:#00a000">room</span>))))
           (<span style="color:#b8860b">existing-entity</span> (<span style="color:#b8860b">entity-at</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>)))
      (<span style="color:#a2f">unless</span> <span style="color:#b8860b">existing-entity</span>
<span style="display:block;width:100%;background-color:#dfdfdf">        (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">item-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;item</span>))
</span>               (<span style="color:#b8860b">potion</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span> <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Healing Potion&#34;</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:purple</span>)
<span style="display:block;width:100%;background-color:#dfdfdf">                                              <span style="color:#b8860b">:item</span> <span style="color:#b8860b">item-component</span>
</span>                                              <span style="color:#b8860b">:char</span> <span style="color:#b44">#\!</span> <span style="color:#b8860b">:blocks</span> <span style="color:#800">nil</span> <span style="color:#b8860b">:render-order</span> <span style="color:#b8860b">:item</span>)))
          (<span style="color:#00a000">nconc</span> <span style="color:#b8860b">entities</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">potion</span>)))))))</code></pre></td></tr></table>
</div>
</div>

<p>The way we&rsquo;re going to have the player pickup an item is to stand on top of it
and press the &lsquo;g&rsquo; key. We&rsquo;ll start by accepting the players input. Update the
handle-keys function to check for the &lsquo;g&rsquo; key being pressed, and to return a
result that the player wants to pickup an item:</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-keys</span> ()
  (<span style="color:#a2f">when</span> (<span style="color:#b8860b">blt:has-input-p</span>)
    (<span style="color:#b8860b">blt:key-case</span> (<span style="color:#b8860b">blt:read</span>)
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:up</span> <span style="color:#b8860b">:k</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">-1</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:down</span> <span style="color:#b8860b">:j</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">1</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:left</span> <span style="color:#b8860b">:h</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">0</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:right</span> <span style="color:#b8860b">:l</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">0</span>)))
                  (<span style="color:#b8860b">:y</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">-1</span>)))
                  (<span style="color:#b8860b">:u</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">-1</span>)))
                  (<span style="color:#b8860b">:b</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">1</span>)))
                  (<span style="color:#b8860b">:n</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">1</span>)))
<span style="display:block;width:100%;background-color:#dfdfdf">                  (<span style="color:#b8860b">:g</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:pickup</span> <span style="color:#800">t</span>))
</span>                  (<span style="color:#b8860b">:escape</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>))
                  (<span style="color:#b8860b">:close</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>)))))</code></pre></td></tr></table>
</div>
</div>

<p>The inventory class will need a method to add new items to it&rsquo;s item list:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defgeneric</span> <span style="color:#b8860b">add-item</span> (<span style="color:#b8860b">inventory</span> <span style="color:#b8860b">item</span>))
(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">add-item</span> ((<span style="color:#b8860b">inventory</span> <span style="color:#b8860b">inventory</span>) (<span style="color:#b8860b">item</span> <span style="color:#b8860b">entity</span>))
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">results</span> <span style="color:#800">nil</span>))
    (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">items</span> <span style="color:#b8860b">capacity</span>) <span style="color:#b8860b">inventory</span>
      (<span style="color:#a2f">cond</span>
        ((<span style="color:#00a000">&gt;=</span> (<span style="color:#00a000">length</span> <span style="color:#b8860b">items</span>) <span style="color:#b8860b">capacity</span>)
         (<span style="color:#a2f">setf</span> <span style="color:#b8860b">results</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:item-added</span> <span style="color:#800">nil</span>
                             <span style="color:#b8860b">:message</span> <span style="color:#b44">&#34;You cannot carry any more, your inventory is full&#34;</span>)))
        (<span style="color:#800">t</span>
         (<span style="color:#a2f">setf</span> <span style="color:#b8860b">results</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:item-added</span> <span style="color:#b8860b">item</span>
                             <span style="color:#b8860b">:message</span> (<span style="color:#00a000">format</span> <span style="color:#800">nil</span> <span style="color:#b44">&#34;You pick up the ~A&#34;</span> (<span style="color:#b8860b">entity/name</span> <span style="color:#b8860b">item</span>))
                             <span style="color:#b8860b">:message-color</span> (<span style="color:#b8860b">blt:yellow</span>)))
         (<span style="color:#a2f">setf</span> <span style="color:#b8860b">items</span> (<span style="color:#00a000">append</span> <span style="color:#b8860b">items</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">item</span>))))))
    <span style="color:#b8860b">results</span>))</code></pre></div>
<p>Next, we&rsquo;ll need a way to process the results of adding an item to the
inventory. But before we do, the game-tick function is getting a little large,
so lets pull out the turn handling code into separate functions for the
player-turn, handle-player-results, and enemy-turn:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">player-turn</span> (<span style="color:#b8860b">game-state</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">action</span>)
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">player-turn-results</span> <span style="color:#800">nil</span>)
        (<span style="color:#b8860b">move</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:move</span>)))
    (<span style="color:#a2f">when</span> <span style="color:#b8860b">move</span>
      (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">destination-x</span> (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>)))
            (<span style="color:#b8860b">destination-y</span> (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))))
        (<span style="color:#a2f">unless</span> (<span style="color:#b8860b">blocked-p</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)
          (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">target</span> (<span style="color:#b8860b">blocking-entity-at</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)))
            (<span style="color:#a2f">cond</span> (<span style="color:#b8860b">target</span>
                   (<span style="color:#a2f">setf</span> <span style="color:#b8860b">player-turn-results</span> (<span style="color:#b8860b">attack</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">target</span>)))
                  (<span style="color:#800">t</span>
                   (<span style="color:#b8860b">move</span> <span style="color:#b8860b">player</span> (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))
                   (<span style="color:#b8860b">fov</span> <span style="color:#00a000">map</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>)))))
          (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>))))

    (<span style="color:#00a000">values</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">game-state</span>)))

(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-player-results</span> (<span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#00a000">log</span>)
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">message</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:message</span>))
        (<span style="color:#b8860b">message-color</span> (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:message-color</span>)
                           (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:message-color</span>)
                           (<span style="color:#b8860b">blt:white</span>)))
        (<span style="color:#b8860b">dead-entity</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:dead</span>))
        (<span style="color:#b8860b">item-added</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:item-added</span>)))
    (<span style="color:#a2f">when</span> <span style="color:#b8860b">message</span>
      (<span style="color:#b8860b">add-message</span> <span style="color:#00a000">log</span> <span style="color:#b8860b">message</span> <span style="color:#b8860b">:color</span> <span style="color:#b8860b">message-color</span>))
    (<span style="color:#a2f">when</span> <span style="color:#b8860b">dead-entity</span>
      (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">equal</span> <span style="color:#b8860b">dead-entity</span> <span style="color:#b8860b">player</span>)
             (<span style="color:#a2f">setf</span> (<span style="color:#00a000">values</span> <span style="color:#b8860b">message</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>))
                   (<span style="color:#b8860b">kill-player</span> <span style="color:#b8860b">dead-entity</span>)))
            (<span style="color:#800">t</span>
             (<span style="color:#a2f">setf</span> <span style="color:#b8860b">message</span> (<span style="color:#b8860b">kill-monster</span> <span style="color:#b8860b">dead-entity</span>))))
      (<span style="color:#b8860b">add-message</span> <span style="color:#00a000">log</span> <span style="color:#b8860b">message</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:orange</span>))))
  <span style="color:#b8860b">game-state</span>)

(<span style="color:#a2f">defun</span> <span style="color:#b8860b">enemy-turn</span> (<span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#00a000">log</span>)
  (<span style="color:#a2f">dolist</span> (<span style="color:#b8860b">entity</span> (<span style="color:#00a000">remove-if-not</span> <span style="color:#00a000">#&#39;</span><span style="color:#b8860b">entity/ai</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>)))
    (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">enemy-turn-results</span> (<span style="color:#b8860b">take-turn</span> (<span style="color:#b8860b">entity/ai</span> <span style="color:#b8860b">entity</span>) <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>)))
           (<span style="color:#b8860b">message</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">enemy-turn-results</span> <span style="color:#b8860b">:message</span>))
           (<span style="color:#b8860b">dead-entity</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">enemy-turn-results</span> <span style="color:#b8860b">:dead</span>)))
      (<span style="color:#a2f">when</span> <span style="color:#b8860b">message</span>
        (<span style="color:#b8860b">add-message</span> <span style="color:#00a000">log</span> <span style="color:#b8860b">message</span>))
      (<span style="color:#a2f">when</span> <span style="color:#b8860b">dead-entity</span>
        (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">equal</span> <span style="color:#b8860b">dead-entity</span> <span style="color:#b8860b">player</span>)
               (<span style="color:#a2f">setf</span> (<span style="color:#00a000">values</span> <span style="color:#b8860b">message</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>))
                     (<span style="color:#b8860b">kill-player</span> <span style="color:#b8860b">dead-entity</span>)))
              (<span style="color:#800">t</span>
               (<span style="color:#a2f">setf</span> <span style="color:#b8860b">message</span> (<span style="color:#b8860b">kill-monster</span> <span style="color:#b8860b">dead-entity</span>))))
        (<span style="color:#b8860b">add-message</span> <span style="color:#00a000">log</span> <span style="color:#b8860b">message</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:red</span>)))))
  <span style="color:#b8860b">game-state</span>)

(<span style="color:#a2f">defun</span> <span style="color:#b8860b">game-tick</span> (<span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">stats-panel</span> <span style="color:#00a000">log</span>)
  (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">type</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">game-state</span>))
  (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">type</span> <span style="color:#b8860b">message-log</span> <span style="color:#00a000">log</span>))
  (<span style="color:#b8860b">render-all</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">stats-panel</span> *screen-width* *screen-height*)
  (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">player-turn-results</span> <span style="color:#800">nil</span>)
         (<span style="color:#b8860b">action</span> (<span style="color:#b8860b">handle-keys</span> <span style="color:#b8860b">game-state</span>))
         (<span style="color:#b8860b">exit</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:quit</span>)))

    (<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>)
      (<span style="color:#a2f">setf</span> (<span style="color:#00a000">values</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">game-state</span>) (<span style="color:#b8860b">player-turn</span> <span style="color:#b8860b">game-state</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">action</span>)))

    (<span style="color:#a2f">when</span> <span style="color:#b8860b">exit</span>
      (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#a2f">or</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:show-inventory</span>)
              (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:drop-inventory</span>))
          (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) (<span style="color:#b8860b">game-state/previous-state</span> <span style="color:#b8860b">game-state</span>))
          (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/running</span> <span style="color:#b8860b">game-state</span>) <span style="color:#800">nil</span>)))

    (<span style="color:#a2f">setf</span> <span style="color:#b8860b">game-state</span> (<span style="color:#b8860b">handle-player-results</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#00a000">log</span>))

    (<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>)
      (<span style="color:#a2f">setf</span> <span style="color:#b8860b">game-state</span> (<span style="color:#b8860b">enemy-turn</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#00a000">log</span>))
      (<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-dead</span>)
        (<span style="color:#a2f;font-weight:bold">return-from</span> <span style="color:#b8860b">game-tick</span> <span style="color:#b8860b">game-state</span>))
      (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>)))

  <span style="color:#b8860b">game-state</span>)</code></pre></div>
<p>Now, we can handle the item pickup action. When the player wants to pickup an
item, we will loop through all of the entities to see which ones are on the same
tile as the player. If one of the entities is on the same tile, and it is an
item, then the player will pick it up.</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">player-turn</span> (<span style="color:#b8860b">game-state</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">action</span>)
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">player-turn-results</span> <span style="color:#800">nil</span>)
        (<span style="color:#b8860b">move</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:move</span>))
<span style="display:block;width:100%;background-color:#dfdfdf">        (<span style="color:#b8860b">pickup</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:pickup</span>)))
</span>    (<span style="color:#a2f">when</span> <span style="color:#b8860b">move</span>
      (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">destination-x</span> (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>)))
            (<span style="color:#b8860b">destination-y</span> (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))))
        (<span style="color:#a2f">unless</span> (<span style="color:#b8860b">blocked-p</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)
          (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">target</span> (<span style="color:#b8860b">blocking-entity-at</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)))
            (<span style="color:#a2f">cond</span> (<span style="color:#b8860b">target</span>
                   (<span style="color:#a2f">setf</span> <span style="color:#b8860b">player-turn-results</span> (<span style="color:#b8860b">attack</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">target</span>)))
                  (<span style="color:#800">t</span>
                   (<span style="color:#b8860b">move</span> <span style="color:#b8860b">player</span> (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))
                   (<span style="color:#b8860b">fov</span> <span style="color:#00a000">map</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>)))))
          (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>))))

<span style="display:block;width:100%;background-color:#dfdfdf">    (<span style="color:#a2f">when</span> <span style="color:#b8860b">pickup</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">      (<span style="color:#a2f">dolist</span> (<span style="color:#b8860b">entity</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>))
</span><span style="display:block;width:100%;background-color:#dfdfdf">        (<span style="color:#a2f">when</span> (<span style="color:#a2f">and</span> (<span style="color:#b8860b">entity/item</span> <span style="color:#b8860b">entity</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                   (<span style="color:#00a000">=</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">entity</span>) (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>))
</span><span style="display:block;width:100%;background-color:#dfdfdf">                   (<span style="color:#00a000">=</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">entity</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>)))
</span><span style="display:block;width:100%;background-color:#dfdfdf">          (<span style="color:#a2f">setf</span> <span style="color:#b8860b">player-turn-results</span> (<span style="color:#b8860b">add-item</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">entity</span>)))))
</span>
    (<span style="color:#00a000">values</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">game-state</span>)))</code></pre></td></tr></table>
</div>
</div>

<p>Then, process the results of pickup up the item. When the item is picked up, it
needs to be removed from the entities list so that it is no longer rendered on
the map. Picking up an item should also use up the player&rsquo;s turn.</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-player-results</span> (<span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#00a000">log</span>)
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">message</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:message</span>))
        (<span style="color:#b8860b">message-color</span> (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:message-color</span>)
                           (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:message-color</span>)
                           (<span style="color:#b8860b">blt:white</span>)))
        (<span style="color:#b8860b">dead-entity</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:dead</span>))
<span style="display:block;width:100%;background-color:#dfdfdf">        (<span style="color:#b8860b">item-added</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">:item-added</span>)))
</span>    (<span style="color:#a2f">when</span> <span style="color:#b8860b">message</span>
      (<span style="color:#b8860b">add-message</span> <span style="color:#00a000">log</span> <span style="color:#b8860b">message</span> <span style="color:#b8860b">:color</span> <span style="color:#b8860b">message-color</span>))
    (<span style="color:#a2f">when</span> <span style="color:#b8860b">dead-entity</span>
      (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">equal</span> <span style="color:#b8860b">dead-entity</span> <span style="color:#b8860b">player</span>)
             (<span style="color:#a2f">setf</span> (<span style="color:#00a000">values</span> <span style="color:#b8860b">message</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>))
                   (<span style="color:#b8860b">kill-player</span> <span style="color:#b8860b">dead-entity</span>)))
            (<span style="color:#800">t</span>
             (<span style="color:#a2f">setf</span> <span style="color:#b8860b">message</span> (<span style="color:#b8860b">kill-monster</span> <span style="color:#b8860b">dead-entity</span>))))
      (<span style="color:#b8860b">add-message</span> <span style="color:#00a000">log</span> <span style="color:#b8860b">message</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:orange</span>)))
<span style="display:block;width:100%;background-color:#dfdfdf">    (<span style="color:#a2f">when</span> <span style="color:#b8860b">item-added</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">      (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>) (<span style="color:#00a000">remove-if</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">                                              <span style="color:#00a000">#&#39;</span>(<span style="color:#a2f">lambda</span> (<span style="color:#b8860b">entity</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                                                  (<span style="color:#00a000">eql</span> <span style="color:#b8860b">entity</span> <span style="color:#b8860b">item-added</span>))
</span><span style="display:block;width:100%;background-color:#dfdfdf">                                              (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>))
</span><span style="display:block;width:100%;background-color:#dfdfdf">            (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>)))
</span>  <span style="color:#b8860b">game-state</span>)</code></pre></td></tr></table>
</div>
</div>

<p>Now, if you run the game, you should be able to pick up the healing potions by
pressing &lsquo;g&rsquo; while on the same tile. However, you aren&rsquo;t able to do anything
with the yet. Before we can implement using items, we need to be able to display
what the player has in their inventory.</p>

<h2 id="displaying-the-inventory-menu">Displaying the inventory menu</h2>

<p>We&rsquo;re going to add in an inventory menu that the player will be able to
display by pressing &lsquo;i&rsquo;. From the inventory menu, the player will be presented
with all of the items they are holding, and shown a keyboard button they can
press which will correspond with each item.</p>

<p>To start, create a new &ldquo;menu.lisp&rdquo; file, with a generic &ldquo;menu&rdquo; function that
will handle rendering the menu with a header and a list of options to display.
For each item in the list of options, it will display an alphabetic character
which the player can press to use the items, starting at &lsquo;a&rsquo; and increasing by
one for each subsequent option. Since it will use one alphabetic character as
the keyboard shortcut for every item, it will be limited to displaying a maximum
of 26 options.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">menu</span> (<span style="color:#b8860b">header</span> <span style="color:#b8860b">options</span> <span style="color:#b8860b">width</span> <span style="color:#b8860b">screen-width</span> <span style="color:#b8860b">screen-height</span>)
  (<span style="color:#a2f">assert</span> (<span style="color:#00a000">&lt;=</span> (<span style="color:#00a000">length</span> <span style="color:#b8860b">options</span>) <span style="color:#666">26</span>))

  (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">header-height</span> <span style="color:#666">3</span>)
         (<span style="color:#b8860b">height</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">length</span> <span style="color:#b8860b">options</span>) <span style="color:#b8860b">header-height</span> <span style="color:#666">1</span>))
         (<span style="color:#b8860b">box-x</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">-</span> (<span style="color:#00a000">/</span> <span style="color:#b8860b">screen-width</span> <span style="color:#666">2</span>) (<span style="color:#00a000">/</span> <span style="color:#b8860b">width</span> <span style="color:#666">2</span>))))
         (<span style="color:#b8860b">box-y</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">-</span> (<span style="color:#00a000">/</span> <span style="color:#b8860b">screen-height</span> <span style="color:#666">2</span>) (<span style="color:#00a000">/</span> <span style="color:#b8860b">height</span> <span style="color:#666">2</span>)))))

    (<span style="color:#b8860b">blt:draw-box</span> <span style="color:#b8860b">box-x</span> <span style="color:#b8860b">box-y</span> <span style="color:#b8860b">width</span> <span style="color:#b8860b">height</span> <span style="color:#b8860b">:contents</span> <span style="color:#b8860b">header</span>)

    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">y</span> (<span style="color:#00a000">+</span> <span style="color:#b8860b">header-height</span> <span style="color:#b8860b">box-y</span>))
          (<span style="color:#b8860b">letter-index</span> (<span style="color:#00a000">char-code</span> <span style="color:#b44">#\a</span>)))
      (<span style="color:#a2f">dolist</span> (<span style="color:#b8860b">option-text</span> <span style="color:#b8860b">options</span>)
        (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">text</span> (<span style="color:#00a000">concatenate</span> <span style="color:#b8860b">&#39;string</span> <span style="color:#b44">&#34;(&#34;</span> (<span style="color:#00f">string</span> (<span style="color:#00a000">code-char</span> <span style="color:#b8860b">letter-index</span>)) <span style="color:#b44">&#34;) &#34;</span> <span style="color:#b8860b">option-text</span>)))
          (<span style="color:#b8860b">blt:print</span> (<span style="color:#00a000">1+</span> <span style="color:#b8860b">box-x</span>) <span style="color:#b8860b">y</span> <span style="color:#b8860b">text</span>)
          (<span style="color:#a2f">incf</span> <span style="color:#b8860b">y</span>)
          (<span style="color:#a2f">incf</span> <span style="color:#b8860b">letter-index</span>))))))</code></pre></div>
<p>Next, create an inventory-menu function that will pass the inventory items
through to the more generic &ldquo;menu&rdquo; function:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">inventory-menu</span> (<span style="color:#b8860b">header</span> <span style="color:#b8860b">inventory</span> <span style="color:#b8860b">inventory-width</span> <span style="color:#b8860b">screen-width</span> <span style="color:#b8860b">screen-height</span>)
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">options</span> (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#00a000">zerop</span> (<span style="color:#00a000">length</span> (<span style="color:#b8860b">inventory/items</span> <span style="color:#b8860b">inventory</span>)))
                     <span style="color:#666">&#39;</span>(<span style="color:#b44">&#34;Inventory is empty.&#34;</span>)
                     (<span style="color:#00a000">mapcar</span> <span style="color:#00a000">#&#39;</span>(<span style="color:#a2f">lambda</span> (<span style="color:#b8860b">i</span>)
                                 (<span style="color:#b8860b">entity/name</span> <span style="color:#b8860b">i</span>))
                             (<span style="color:#b8860b">inventory/items</span> <span style="color:#b8860b">inventory</span>)))))
    (<span style="color:#b8860b">menu</span> <span style="color:#b8860b">header</span> <span style="color:#b8860b">options</span> <span style="color:#b8860b">inventory-width</span> <span style="color:#b8860b">screen-width</span> <span style="color:#b8860b">screen-height</span>)))</code></pre></div>
<p>We now need to be able to display the menu. When the player opens the inventory,
we will have the game switch to a new &ldquo;show-inventory&rdquo; state. We&rsquo;ll need to also
track the previous state that the game was in so that when the inventory menu is
closed, the game returns to the correct state so that the player doesn&rsquo;t lose a
turn if they just open and close the inventory without using anything. We&rsquo;ll use
the &lsquo;i&rsquo; key to open the inventory.</p>

<p>Update the game-state class to hold the previous state:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">game-state</span> ()
  ((<span style="color:#b8860b">state</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:state</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">game-state/state</span>)
   (<span style="color:#b8860b">previous-state</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:previous-state</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">game-state/previous-state</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)
   (<span style="color:#b8860b">entities</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:entities</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">game-state/entities</span>)
   (<span style="color:#b8860b">running</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:running</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">game-state/running</span>)))

(<span style="color:#a2f">defmethod</span> <span style="color:#00a000">initialize-instance</span> <span style="color:#b8860b">:after</span> ((<span style="color:#b8860b">game-state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#a2f;font-weight:bold">&amp;rest</span> <span style="color:#b8860b">initargs</span>)
  (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">ignore</span> <span style="color:#b8860b">initargs</span>))
  (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">state</span> <span style="color:#b8860b">previous-state</span>) <span style="color:#b8860b">game-state</span>
    (<span style="color:#a2f">unless</span> <span style="color:#b8860b">previous-state</span>
      (<span style="color:#a2f">setf</span> <span style="color:#b8860b">previous-state</span> <span style="color:#b8860b">state</span>))))</code></pre></div>
<p>Update the handle-keys function to check for the &lsquo;i&rsquo; key:</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-keys</span> ()
  (<span style="color:#a2f">when</span> (<span style="color:#b8860b">blt:has-input-p</span>)
    (<span style="color:#b8860b">blt:key-case</span> (<span style="color:#b8860b">blt:read</span>)
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:up</span> <span style="color:#b8860b">:k</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">-1</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:down</span> <span style="color:#b8860b">:j</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">1</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:left</span> <span style="color:#b8860b">:h</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">0</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:right</span> <span style="color:#b8860b">:l</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">0</span>)))
                  (<span style="color:#b8860b">:y</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">-1</span>)))
                  (<span style="color:#b8860b">:u</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">-1</span>)))
                  (<span style="color:#b8860b">:b</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">1</span>)))
                  (<span style="color:#b8860b">:n</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">1</span>)))
                  (<span style="color:#b8860b">:g</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:pickup</span> <span style="color:#800">t</span>))
<span style="display:block;width:100%;background-color:#dfdfdf">                  (<span style="color:#b8860b">:i</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:show-inventory</span> <span style="color:#800">t</span>))
</span>                  (<span style="color:#b8860b">:escape</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>))
                  (<span style="color:#b8860b">:close</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>)))))</code></pre></td></tr></table>
</div>
</div>

<p>Update the player-turn function to check for the show-inventory action, change
the state to show-inventory and store the current state:</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">player-turn</span> (<span style="color:#b8860b">game-state</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">action</span>)
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">player-turn-results</span> <span style="color:#800">nil</span>)
        (<span style="color:#b8860b">move</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:move</span>))
        (<span style="color:#b8860b">pickup</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:pickup</span>))
<span style="display:block;width:100%;background-color:#dfdfdf">        (<span style="color:#b8860b">show-inventory</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:show-inventory</span>)))
</span>    (<span style="color:#a2f">when</span> <span style="color:#b8860b">move</span>
      (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">destination-x</span> (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>)))
            (<span style="color:#b8860b">destination-y</span> (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))))
        (<span style="color:#a2f">unless</span> (<span style="color:#b8860b">blocked-p</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)
          (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">target</span> (<span style="color:#b8860b">blocking-entity-at</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)))
            (<span style="color:#a2f">cond</span> (<span style="color:#b8860b">target</span>
                   (<span style="color:#a2f">setf</span> <span style="color:#b8860b">player-turn-results</span> (<span style="color:#b8860b">attack</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">target</span>)))
                  (<span style="color:#800">t</span>
                   (<span style="color:#b8860b">move</span> <span style="color:#b8860b">player</span> (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))
                   (<span style="color:#b8860b">fov</span> <span style="color:#00a000">map</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>)))))
          (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>))))

    (<span style="color:#a2f">when</span> <span style="color:#b8860b">pickup</span>
      (<span style="color:#a2f">dolist</span> (<span style="color:#b8860b">entity</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>))
        (<span style="color:#a2f">when</span> (<span style="color:#a2f">and</span> (<span style="color:#b8860b">entity/item</span> <span style="color:#b8860b">entity</span>)
                   (<span style="color:#00a000">=</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">entity</span>) (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>))
                   (<span style="color:#00a000">=</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">entity</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>)))
          (<span style="color:#a2f">setf</span> <span style="color:#b8860b">player-turn-results</span> (<span style="color:#b8860b">add-item</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">entity</span>)))))

<span style="display:block;width:100%;background-color:#dfdfdf">    (<span style="color:#a2f">when</span> <span style="color:#b8860b">show-inventory</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">      (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">previous-state</span> <span style="color:#b8860b">state</span>) <span style="color:#b8860b">game-state</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">        (<span style="color:#a2f">setf</span> <span style="color:#b8860b">previous-state</span> <span style="color:#b8860b">state</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">              <span style="color:#b8860b">state</span> <span style="color:#b8860b">:show-inventory</span>)))
</span>
    (<span style="color:#00a000">values</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">game-state</span>)))</code></pre></td></tr></table>
</div>
</div>

<p>We&rsquo;ll also want to update the game-tick function so that when &ldquo;escape&rdquo; is
pressed and the inventory menu is open, the menu closes instead of exiting the game.</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">game-tick</span> (<span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">stats-panel</span> <span style="color:#00a000">log</span>)
  (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">type</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">game-state</span>))
  (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">type</span> <span style="color:#b8860b">message-log</span> <span style="color:#00a000">log</span>))
  (<span style="color:#b8860b">render-all</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">stats-panel</span> *screen-width* *screen-height*)
  (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">player-turn-results</span> <span style="color:#800">nil</span>)
         (<span style="color:#b8860b">action</span> (<span style="color:#b8860b">handle-keys</span> <span style="color:#b8860b">game-state</span>))
         (<span style="color:#b8860b">inventory-index</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:inventory-index</span>))
         (<span style="color:#b8860b">exit</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:quit</span>)))

    (<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>)
      (<span style="color:#a2f">setf</span> (<span style="color:#00a000">values</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">game-state</span>) (<span style="color:#b8860b">player-turn</span> <span style="color:#b8860b">game-state</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">action</span>)))

<span style="display:block;width:100%;background-color:#dfdfdf">    (<span style="color:#a2f">when</span> <span style="color:#b8860b">exit</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">      (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:show-inventory</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">          (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) (<span style="color:#b8860b">game-state/previous-state</span> <span style="color:#b8860b">game-state</span>))
</span><span style="display:block;width:100%;background-color:#dfdfdf">          (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/running</span> <span style="color:#b8860b">game-state</span>) <span style="color:#800">nil</span>)))
</span>
    (<span style="color:#a2f">setf</span> <span style="color:#b8860b">game-state</span> (<span style="color:#b8860b">handle-player-results</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#00a000">log</span>))

    (<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>)
      (<span style="color:#a2f">setf</span> <span style="color:#b8860b">game-state</span> (<span style="color:#b8860b">enemy-turn</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#00a000">log</span>))
      (<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-dead</span>)
        (<span style="color:#a2f;font-weight:bold">return-from</span> <span style="color:#b8860b">game-tick</span> <span style="color:#b8860b">game-state</span>))
      (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>)))

  <span style="color:#b8860b">game-state</span>)</code></pre></td></tr></table>
</div>
</div>

<p>Now to finally render the inventory menu, update the render-all function to take
in the game-state as a parameter, and to render the menu when the state is
currently set to show-inventory. Make sure to update the call to render-all to
pass in the new game-state parameter:</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="display:block;width:100%;background-color:#dfdfdf">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">render-all</span> (<span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">stats-panel</span> <span style="color:#b8860b">screen-width</span> <span style="color:#b8860b">screen-height</span>)
</span>  (<span style="color:#b8860b">blt:clear</span>)
  (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">y</span> *map-height*)
    (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">x</span> *map-width*)
      (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">tile</span> (<span style="color:#00a000">aref</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>) <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>))
             (<span style="color:#b8860b">wall</span> (<span style="color:#b8860b">tile/block-sight</span> <span style="color:#b8860b">tile</span>))
             (<span style="color:#b8860b">visible</span> (<span style="color:#b8860b">tile/visible</span> <span style="color:#b8860b">tile</span>))
             (<span style="color:#b8860b">explored</span> (<span style="color:#b8860b">tile/explored</span> <span style="color:#b8860b">tile</span>)))
        (<span style="color:#a2f">cond</span> (<span style="color:#b8860b">visible</span>
               (<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b8860b">wall</span>
                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:light-wall</span>))
                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:light-ground</span>)))
               (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:cell-char</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) <span style="color:#b44">#\Space</span>))
              (<span style="color:#b8860b">explored</span>
               (<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b8860b">wall</span>
                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:dark-wall</span>))
                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#00a000">getf</span> *color-map* <span style="color:#b8860b">:dark-ground</span>)))
               (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:cell-char</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) <span style="color:#b44">#\Space</span>))))))
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">entities</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>)))
    (<span style="color:#00a000">mapc</span> <span style="color:#00a000">#&#39;</span>(<span style="color:#a2f">lambda</span> (<span style="color:#b8860b">entity</span>) (<span style="color:#b8860b">draw</span> <span style="color:#b8860b">entity</span> (<span style="color:#b8860b">game-map/tiles</span> <span style="color:#00a000">map</span>)))
          (<span style="color:#00a000">sort</span> (<span style="color:#00a000">copy-seq</span> <span style="color:#b8860b">entities</span>) <span style="color:#00a000">#&#39;</span><span style="color:#b8860b">render-order-compare</span>))
    (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:background-color</span>) (<span style="color:#b8860b">blt:black</span>)
          (<span style="color:#b8860b">blt:color</span>) (<span style="color:#b8860b">blt:white</span>))
    (<span style="color:#b8860b">render-panel</span> <span style="color:#b8860b">stats-panel</span>)

    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">entity-names</span> (<span style="color:#b8860b">get-names-under-mouse</span> (<span style="color:#b8860b">blt:mouse-x</span>) (<span style="color:#b8860b">blt:mouse-y</span>) <span style="color:#b8860b">entities</span> <span style="color:#00a000">map</span>)))
      (<span style="color:#a2f">when</span> <span style="color:#b8860b">entity-names</span>
        (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">blt:color</span>) (<span style="color:#b8860b">blt:yellow</span>))
        (<span style="color:#b8860b">blt:print</span> (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">panel/x</span> <span style="color:#b8860b">stats-panel</span>)) (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">panel/y</span> <span style="color:#b8860b">stats-panel</span>)) <span style="color:#b8860b">entity-names</span>))))

<span style="display:block;width:100%;background-color:#dfdfdf">  (<span style="color:#a2f">when</span> (<span style="color:#a2f">or</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:show-inventory</span>))
</span><span style="display:block;width:100%;background-color:#dfdfdf">    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">inventory-title</span> <span style="color:#b44">&#34;Press key next to item to use it, or Esc to cancel.&#34;</span>))
</span><span style="display:block;width:100%;background-color:#dfdfdf">      (<span style="color:#b8860b">inventory-menu</span> <span style="color:#b8860b">inventory-title</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>) <span style="color:#666">50</span> <span style="color:#b8860b">screen-width</span> <span style="color:#b8860b">screen-height</span>)))
</span>
  (<span style="color:#b8860b">blt:refresh</span>))</code></pre></td></tr></table>
</div>
</div>

<p>Now, if you run the game, you should be able to open the inventory menu by
pressing &lsquo;i&rsquo;. If you are holding any items, they should be displayed, and you
should be able to press the escape key to close the menu.</p>

<figure>
    <img src="/cl-rltut/inventory-menu.png"/> 
</figure>


<h2 id="using-items">Using items</h2>

<p>Currently, we can open the inventory but we can&rsquo;t use any of the items. In order
to use the items, we&rsquo;re going to need to be able to have different input
handling functions depending on the state of the game. For example, when the
menu is open, we would want to be able to use an item labeled with the &lsquo;j&rsquo; key,
but that key is already mapped for movement.</p>

<p>To start, rename the current &ldquo;handle-keys&rdquo; function to
&ldquo;handle-player-turn-keys&rdquo;, then create a new &ldquo;handle-keys&rdquo; function which will
call it when the game state is &ldquo;players-turn&rdquo;. The call to the &ldquo;handle-keys&rdquo;
function will also need to be modified to pass in the game state.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-keys</span> (<span style="color:#b8860b">game-state</span>)
  (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>)
         (<span style="color:#b8860b">handle-player-turn-keys</span>))))

(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-player-turn-keys</span> ()
  (<span style="color:#a2f">when</span> (<span style="color:#b8860b">blt:has-input-p</span>)
    (<span style="color:#b8860b">blt:key-case</span> (<span style="color:#b8860b">blt:read</span>)
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:up</span> <span style="color:#b8860b">:k</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">-1</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:down</span> <span style="color:#b8860b">:j</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">1</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:left</span> <span style="color:#b8860b">:h</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">0</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:right</span> <span style="color:#b8860b">:l</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">0</span>)))
                  (<span style="color:#b8860b">:y</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">-1</span>)))
                  (<span style="color:#b8860b">:u</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">-1</span>)))
                  (<span style="color:#b8860b">:b</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">1</span>)))
                  (<span style="color:#b8860b">:n</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">1</span>)))
                  (<span style="color:#b8860b">:g</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:pickup</span> <span style="color:#800">t</span>))
                  (<span style="color:#b8860b">:i</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:show-inventory</span> <span style="color:#800">t</span>))
                  (<span style="color:#b8860b">:escape</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>))
                  (<span style="color:#b8860b">:close</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>)))))</code></pre></div>
<p>We should also create a key handling function for when the player is dead, so
that the player can exit the game, and also be able to see what items they had
in their inventory.</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-keys</span> (<span style="color:#b8860b">game-state</span>)
  (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>)
         (<span style="color:#b8860b">handle-player-turn-keys</span>))
<span style="display:block;width:100%;background-color:#dfdfdf">        ((<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-dead</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">         (<span style="color:#b8860b">handle-player-dead-keys</span>))))
</span>
<span style="display:block;width:100%;background-color:#dfdfdf">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-player-dead-keys</span> ()
</span><span style="display:block;width:100%;background-color:#dfdfdf">  (<span style="color:#a2f">when</span> (<span style="color:#b8860b">blt:has-input-p</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">    (<span style="color:#b8860b">blt:key-case</span> (<span style="color:#b8860b">blt:read</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                  (<span style="color:#b8860b">:i</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:show-inventory</span> <span style="color:#800">t</span>))
</span><span style="display:block;width:100%;background-color:#dfdfdf">                  (<span style="color:#b8860b">:escape</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>)))))</span></code></pre></td></tr></table>
</div>
</div>

<p>Now we can create a function to handle inventory keys. If the player presses an
alphabetic key, it should be returned so that we can check if it&rsquo;s to use an
item in their inventory. To do this, we will convert the input character to a
numeric index where &lsquo;a&rsquo; is 0, &lsquo;b&rsquo; is 1, etc.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-keys</span> (<span style="color:#b8860b">game-state</span>)
  (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>)
         (<span style="color:#b8860b">handle-player-turn-keys</span>))
        ((<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-dead</span>)
         (<span style="color:#b8860b">handle-player-dead-keys</span>))
        ((<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:show-inventory</span>)
         (<span style="color:#b8860b">handle-inventory-keys</span>))))

(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-inventory-keys</span> ()
  (<span style="color:#a2f">when</span> (<span style="color:#b8860b">blt:has-input-p</span>)
    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">key</span> (<span style="color:#b8860b">blt:read</span>))
          (<span style="color:#b8860b">char-key</span> (<span style="color:#b8860b">blt:character-input</span>)))
      (<span style="color:#a2f">when</span> <span style="color:#b8860b">char-key</span>
        (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">index</span> (<span style="color:#00a000">-</span> (<span style="color:#00a000">char-code</span> <span style="color:#b8860b">char-key</span>) (<span style="color:#00a000">char-code</span> <span style="color:#b44">#\a</span>))))
          (<span style="color:#a2f">when</span> (<span style="color:#00a000">&gt;=</span> <span style="color:#b8860b">index</span> <span style="color:#666">0</span>)
            (<span style="color:#a2f;font-weight:bold">return-from</span> <span style="color:#b8860b">handle-inventory-keys</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:inventory-index</span> <span style="color:#b8860b">index</span>)))))
      (<span style="color:#b8860b">blt:key-case</span> <span style="color:#b8860b">key</span>
                    (<span style="color:#b8860b">:escape</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>))))))</code></pre></div>
<p>Now, in the &ldquo;game-tick&rdquo; function, let&rsquo;s handle the &ldquo;inventory-index&rdquo; action, and
test that we are able to determine the item the player is trying to use by
printing it&rsquo;s name.</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">game-tick</span> (<span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">stats-panel</span> <span style="color:#00a000">log</span>)
  (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">type</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">game-state</span>))
  (<span style="color:#a2f;font-weight:bold">declare</span> (<span style="color:#a2f;font-weight:bold">type</span> <span style="color:#b8860b">message-log</span> <span style="color:#00a000">log</span>))
  (<span style="color:#b8860b">render-all</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">stats-panel</span> *screen-width* *screen-height*)
  (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">player-turn-results</span> <span style="color:#800">nil</span>)
         (<span style="color:#b8860b">action</span> (<span style="color:#b8860b">handle-keys</span> <span style="color:#b8860b">game-state</span>))
         (<span style="color:#b8860b">inventory-index</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:inventory-index</span>))
         (<span style="color:#b8860b">exit</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:quit</span>)))

    (<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>)
      (<span style="color:#a2f">setf</span> (<span style="color:#00a000">values</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">game-state</span>) (<span style="color:#b8860b">player-turn</span> <span style="color:#b8860b">game-state</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">action</span>)))

    (<span style="color:#a2f">when</span> (<span style="color:#a2f">and</span> <span style="color:#b8860b">inventory-index</span>
               (<span style="color:#00a000">not</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/previous-state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-dead</span>))
               (<span style="color:#00a000">&lt;</span> <span style="color:#b8860b">inventory-index</span> (<span style="color:#00a000">length</span> (<span style="color:#b8860b">inventory/items</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>)))))
      (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">item</span> (<span style="color:#00a000">nth</span> <span style="color:#b8860b">inventory-index</span> (<span style="color:#b8860b">inventory/items</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>)))))
        (<span style="color:#00a000">format</span> <span style="color:#800">t</span> <span style="color:#b44">&#34;~A~%&#34;</span> (<span style="color:#b8860b">entity/name</span> <span style="color:#b8860b">item</span>))))

    (<span style="color:#a2f">when</span> <span style="color:#b8860b">exit</span>
      (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#a2f">or</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:show-inventory</span>)
              (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:drop-inventory</span>))
          (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) (<span style="color:#b8860b">game-state/previous-state</span> <span style="color:#b8860b">game-state</span>))
          (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/running</span> <span style="color:#b8860b">game-state</span>) <span style="color:#800">nil</span>)))

    (<span style="color:#a2f">setf</span> <span style="color:#b8860b">game-state</span> (<span style="color:#b8860b">handle-player-results</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#00a000">log</span>))

    (<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>)
      (<span style="color:#a2f">setf</span> <span style="color:#b8860b">game-state</span> (<span style="color:#b8860b">enemy-turn</span> <span style="color:#b8860b">game-state</span> <span style="color:#b8860b">player</span> <span style="color:#00a000">map</span> <span style="color:#00a000">log</span>))
      (<span style="color:#a2f">when</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-dead</span>)
        (<span style="color:#a2f;font-weight:bold">return-from</span> <span style="color:#b8860b">game-tick</span> <span style="color:#b8860b">game-state</span>))
      (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>)))

  <span style="color:#b8860b">game-state</span>)</code></pre></td></tr></table>
</div>
</div>

<p>If you run the game and pick up some items, you should be able to test using the
items from the inventory and see their names printed to the console.</p>

<p>Now that we are able to determine the item that the player is trying to use, we
need to be able to apply the effects of using the item. To do this, we&rsquo;ll add
&ldquo;use-function&rdquo; and &ldquo;use-args&rdquo; slots to the &ldquo;item&rdquo; component. The &ldquo;use-function&rdquo;
slot will store a pointer to the function that should be called when using a
particular item. In this case, it would be to call a &ldquo;heal&rdquo; function for the
healing potions. The &ldquo;use-args&rdquo; slot will hold the arguments that should be sent
to the &ldquo;use-function&rdquo;, such as the amount of health the item will heal.
Let&rsquo;s add the slots to the item component:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defclass</span> <span style="color:#b8860b">item</span> (<span style="color:#b8860b">component</span>)
  ((<span style="color:#b8860b">use-function</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:use-function</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">item/use-function</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)
   (<span style="color:#b8860b">use-args</span> <span style="color:#b8860b">:initarg</span> <span style="color:#b8860b">:use-args</span> <span style="color:#b8860b">:accessor</span> <span style="color:#b8860b">item/use-args</span> <span style="color:#b8860b">:initform</span> <span style="color:#800">nil</span>)))</code></pre></div>
<p>Create a &ldquo;item-functions.lisp&rdquo; file and add the &ldquo;heal&rdquo; function. This will take
the item component and a target to apply the healing to. The &ldquo;use-args&rdquo; slot
will contain the healing amount. The function will return a result on whether
the item was consumed and should be removed from the inventory, and a message to
be printed to the log. If the player is already at full health, we won&rsquo;t consume
the item so that it is not wasted.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">heal</span> (<span style="color:#b8860b">item</span> <span style="color:#b8860b">target</span>)
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">amount</span> (<span style="color:#00a000">getf</span> (<span style="color:#b8860b">item/use-args</span> <span style="color:#b8860b">item</span>) <span style="color:#b8860b">:heal-amount</span>)))
    (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">hp</span> <span style="color:#b8860b">max-hp</span>) (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">target</span>)
      (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">=</span> <span style="color:#b8860b">hp</span> <span style="color:#b8860b">max-hp</span>)
             (<span style="color:#00f">list</span> <span style="color:#b8860b">:consumed</span> <span style="color:#800">nil</span> <span style="color:#b8860b">:message</span> <span style="color:#b44">&#34;You are already at full health.&#34;</span> <span style="color:#b8860b">:message-color</span> (<span style="color:#b8860b">blt:yellow</span>)))
            (<span style="color:#800">t</span>
             (<span style="color:#a2f">incf</span> <span style="color:#b8860b">hp</span> <span style="color:#b8860b">amount</span>)
             (<span style="color:#a2f">when</span> (<span style="color:#00a000">&gt;</span> <span style="color:#b8860b">hp</span> <span style="color:#b8860b">max-hp</span>)
               (<span style="color:#a2f">setf</span> <span style="color:#b8860b">hp</span> <span style="color:#b8860b">max-hp</span>))
             (<span style="color:#00f">list</span> <span style="color:#b8860b">:consumed</span> <span style="color:#800">t</span> <span style="color:#b8860b">:message</span> <span style="color:#b44">&#34;Your wounds start to feel better!&#34;</span> <span style="color:#b8860b">:message-color</span> (<span style="color:#b8860b">blt:green</span>)))))))</code></pre></div>
<p>Now we need to add the use-function and use-args to the health potion when it is
created. Update the &ldquo;place-items&rdquo; function:</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">place-items</span> (<span style="color:#00a000">room</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">num-items</span>)
  (<span style="color:#a2f">dotimes</span> (<span style="color:#b8860b">item-index</span> <span style="color:#b8860b">num-items</span>)
    (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">x</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">rect/x2</span> <span style="color:#00a000">room</span>) (<span style="color:#b8860b">rect/x1</span> <span style="color:#00a000">room</span>) <span style="color:#666">1</span>) <span style="color:#666">2</span>))) (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/x1</span> <span style="color:#00a000">room</span>))))
           (<span style="color:#b8860b">y</span> (<span style="color:#00a000">+</span> (<span style="color:#00a000">random</span> (<span style="color:#00a000">round</span> (<span style="color:#00a000">/</span> (<span style="color:#00a000">-</span> (<span style="color:#b8860b">rect/y2</span> <span style="color:#00a000">room</span>) (<span style="color:#b8860b">rect/y1</span> <span style="color:#00a000">room</span>) <span style="color:#666">1</span>) <span style="color:#666">2</span>))) (<span style="color:#00a000">1+</span> (<span style="color:#b8860b">rect/y1</span> <span style="color:#00a000">room</span>))))
           (<span style="color:#b8860b">existing-entity</span> (<span style="color:#b8860b">entity-at</span> <span style="color:#b8860b">entities</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>)))
      (<span style="color:#a2f">unless</span> <span style="color:#b8860b">existing-entity</span>
<span style="display:block;width:100%;background-color:#dfdfdf">        (<span style="color:#a2f;font-weight:bold">let*</span> ((<span style="color:#b8860b">item-component</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;item</span> <span style="color:#b8860b">:use-function</span> <span style="color:#00a000">#&#39;</span><span style="color:#b8860b">heal</span> <span style="color:#b8860b">:use-args</span> <span style="color:#666">&#39;</span>(<span style="color:#b8860b">:heal-amount</span> <span style="color:#666">4</span>)))
</span>               (<span style="color:#b8860b">potion</span> (<span style="color:#00a000">make-instance</span> <span style="color:#b8860b">&#39;entity</span> <span style="color:#b8860b">:name</span> <span style="color:#b44">&#34;Healing Potion&#34;</span> <span style="color:#b8860b">:x</span> <span style="color:#b8860b">x</span> <span style="color:#b8860b">:y</span> <span style="color:#b8860b">y</span> <span style="color:#b8860b">:color</span> (<span style="color:#b8860b">blt:purple</span>)
                                              <span style="color:#b8860b">:item</span> <span style="color:#b8860b">item-component</span>
                                              <span style="color:#b8860b">:char</span> <span style="color:#b44">#\!</span> <span style="color:#b8860b">:blocks</span> <span style="color:#800">nil</span> <span style="color:#b8860b">:render-order</span> <span style="color:#b8860b">:item</span>)))
          (<span style="color:#00a000">nconc</span> <span style="color:#b8860b">entities</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">potion</span>)))))))</code></pre></td></tr></table>
</div>
</div>

<p>Now that the item has the function to be called when it is used, we can remove
the debug print statement from the &ldquo;game-tick&rdquo; function, and actually call the
function to use the item. If the item was consumed, then remove it from the
inventory and set the game state to the enemies turn.</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">when</span> (<span style="color:#a2f">and</span> <span style="color:#b8860b">inventory-index</span>
            (<span style="color:#00a000">not</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/previous-state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-dead</span>))
            (<span style="color:#00a000">&lt;</span> <span style="color:#b8860b">inventory-index</span> (<span style="color:#00a000">length</span> (<span style="color:#b8860b">inventory/items</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>)))))
    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">item</span> (<span style="color:#00a000">nth</span> <span style="color:#b8860b">inventory-index</span> (<span style="color:#b8860b">inventory/items</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>)))))
<span style="display:block;width:100%;background-color:#dfdfdf">        (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:show-inventory</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">use-result</span> (<span style="color:#00a000">funcall</span> (<span style="color:#b8860b">item/use-function</span> (<span style="color:#b8860b">entity/item</span> <span style="color:#b8860b">item</span>)) (<span style="color:#b8860b">entity/item</span> <span style="color:#b8860b">item</span>) <span style="color:#b8860b">player</span>)))
</span><span style="display:block;width:100%;background-color:#dfdfdf">                    (<span style="color:#a2f">setf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">use-result</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                    (<span style="color:#a2f">when</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">use-result</span> <span style="color:#b8860b">:consumed</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                        (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                        (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">inventory/items</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>))
</span><span style="display:block;width:100%;background-color:#dfdfdf">                                (<span style="color:#00a000">remove-if</span> <span style="color:#00a000">#&#39;</span>(<span style="color:#a2f">lambda</span> (<span style="color:#b8860b">i</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                                            (<span style="color:#00a000">eql</span> <span style="color:#b8860b">i</span> <span style="color:#b8860b">item</span>))
</span><span style="display:block;width:100%;background-color:#dfdfdf">                                        (<span style="color:#b8860b">inventory/items</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>))))))))))</span></code></pre></td></tr></table>
</div>
</div>

<p>Now if you run the game, you can pick up health potions and use them to heal
yourself! The message log should print the results of using the function.
<img src="/cl-rltut/use-items.gif" alt="" /></p>

<h2 id="dropping-items">Dropping items</h2>

<p>The final thing we want to add in this part is the ability to drop items from
the inventory. It&rsquo;s not particularly useful in the current state in the game,
but in the future when there are more items, the player will want to be able to
drop items that they don&rsquo;t need in order to free up space to pick up new items.
This will involve adding a new &ldquo;drop-inventory&rdquo; state, and handling the &rsquo;d&rsquo; key
to enter the state:</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-player-turn-keys</span> ()
  (<span style="color:#a2f">when</span> (<span style="color:#b8860b">blt:has-input-p</span>)
    (<span style="color:#b8860b">blt:key-case</span> (<span style="color:#b8860b">blt:read</span>)
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:up</span> <span style="color:#b8860b">:k</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">-1</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:down</span> <span style="color:#b8860b">:j</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">0</span> <span style="color:#666">1</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:left</span> <span style="color:#b8860b">:h</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">0</span>)))
                  ((<span style="color:#a2f">or</span> <span style="color:#b8860b">:right</span> <span style="color:#b8860b">:l</span>) (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">0</span>)))
                  (<span style="color:#b8860b">:y</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">-1</span>)))
                  (<span style="color:#b8860b">:u</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">-1</span>)))
                  (<span style="color:#b8860b">:b</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">-1</span> <span style="color:#666">1</span>)))
                  (<span style="color:#b8860b">:n</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:move</span> (<span style="color:#00f">cons</span> <span style="color:#666">1</span> <span style="color:#666">1</span>)))
                  (<span style="color:#b8860b">:g</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:pickup</span> <span style="color:#800">t</span>))
                  (<span style="color:#b8860b">:i</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:show-inventory</span> <span style="color:#800">t</span>))
<span style="display:block;width:100%;background-color:#dfdfdf">                  (<span style="color:#b8860b">:d</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:drop-inventory</span> <span style="color:#800">t</span>))
</span>                  (<span style="color:#b8860b">:escape</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>))
                  (<span style="color:#b8860b">:close</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:quit</span> <span style="color:#800">t</span>)))))

(<span style="color:#a2f">defun</span> <span style="color:#b8860b">player-turn</span> (<span style="color:#b8860b">game-state</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">player</span> <span style="color:#b8860b">action</span>)
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">player-turn-results</span> <span style="color:#800">nil</span>)
        (<span style="color:#b8860b">move</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:move</span>))
        (<span style="color:#b8860b">pickup</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:pickup</span>))
        (<span style="color:#b8860b">show-inventory</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:show-inventory</span>))
<span style="display:block;width:100%;background-color:#dfdfdf">        (<span style="color:#b8860b">drop-inventory</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">action</span> <span style="color:#b8860b">:drop-inventory</span>)))
</span>    (<span style="color:#a2f">when</span> <span style="color:#b8860b">move</span>
      (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">destination-x</span> (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>)))
            (<span style="color:#b8860b">destination-y</span> (<span style="color:#00a000">+</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))))
        (<span style="color:#a2f">unless</span> (<span style="color:#b8860b">blocked-p</span> <span style="color:#00a000">map</span> <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)
          (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">target</span> (<span style="color:#b8860b">blocking-entity-at</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">destination-x</span> <span style="color:#b8860b">destination-y</span>)))
            (<span style="color:#a2f">cond</span> (<span style="color:#b8860b">target</span>
                   (<span style="color:#a2f">setf</span> <span style="color:#b8860b">player-turn-results</span> (<span style="color:#b8860b">attack</span> (<span style="color:#b8860b">entity/fighter</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">target</span>)))
                  (<span style="color:#800">t</span>
                   (<span style="color:#b8860b">move</span> <span style="color:#b8860b">player</span> (<span style="color:#00a000">car</span> <span style="color:#b8860b">move</span>) (<span style="color:#00a000">cdr</span> <span style="color:#b8860b">move</span>))
                   (<span style="color:#b8860b">fov</span> <span style="color:#00a000">map</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>)))))
          (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>))))

    (<span style="color:#a2f">when</span> <span style="color:#b8860b">pickup</span>
      (<span style="color:#a2f">dolist</span> (<span style="color:#b8860b">entity</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>))
        (<span style="color:#a2f">when</span> (<span style="color:#a2f">and</span> (<span style="color:#b8860b">entity/item</span> <span style="color:#b8860b">entity</span>)
                   (<span style="color:#00a000">=</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">entity</span>) (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">player</span>))
                   (<span style="color:#00a000">=</span> (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">entity</span>) (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">player</span>)))
          (<span style="color:#a2f">setf</span> <span style="color:#b8860b">player-turn-results</span> (<span style="color:#b8860b">add-item</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">entity</span>)))))

    (<span style="color:#a2f">when</span> <span style="color:#b8860b">show-inventory</span>
      (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">previous-state</span> <span style="color:#b8860b">state</span>) <span style="color:#b8860b">game-state</span>
        (<span style="color:#a2f">setf</span> <span style="color:#b8860b">previous-state</span> <span style="color:#b8860b">state</span>
              <span style="color:#b8860b">state</span> <span style="color:#b8860b">:show-inventory</span>)))

<span style="display:block;width:100%;background-color:#dfdfdf">    (<span style="color:#a2f">when</span> <span style="color:#b8860b">drop-inventory</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">      (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">previous-state</span> <span style="color:#b8860b">state</span>) <span style="color:#b8860b">game-state</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">        (<span style="color:#a2f">setf</span> <span style="color:#b8860b">previous-state</span> <span style="color:#b8860b">state</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">              <span style="color:#b8860b">state</span> <span style="color:#b8860b">:drop-inventory</span>)))
</span>
    (<span style="color:#00a000">values</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">game-state</span>)))</code></pre></td></tr></table>
</div>
</div>

<p>Rather than adding a new key handling function for this state, we can reuse the
function to handle inventory keys since the input will be the same. The
difference will be in how we interpret the results.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defun</span> <span style="color:#b8860b">handle-keys</span> (<span style="color:#b8860b">game-state</span>)
  (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-turn</span>)
         (<span style="color:#b8860b">handle-player-turn-keys</span>))
        ((<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-dead</span>)
         (<span style="color:#b8860b">handle-player-dead-keys</span>))
        ((<span style="color:#a2f">or</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:show-inventory</span>)
             (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:drop-inventory</span>))
         (<span style="color:#b8860b">handle-inventory-keys</span>))))</code></pre></div>
<p>In the &ldquo;game-tick&rdquo; method, make sure to handle the &ldquo;exit&rdquo; state the same way as
with the &ldquo;show-inventory&rdquo; state.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">when</span> <span style="color:#b8860b">exit</span>
    (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#a2f">or</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:show-inventory</span>)
            (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:drop-inventory</span>))
        (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) (<span style="color:#b8860b">game-state/previous-state</span> <span style="color:#b8860b">game-state</span>))
        (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/running</span> <span style="color:#b8860b">game-state</span>) <span style="color:#800">nil</span>)))</code></pre></div>
<p>To display the menu for dropping items, the only difference with the &ldquo;use&rdquo; menu
is the title. Update the call to &ldquo;inventory-menu&rdquo; in the &ldquo;render-all&rdquo; function:</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">when</span> (<span style="color:#a2f">or</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:show-inventory</span>)
<span style="display:block;width:100%;background-color:#dfdfdf">          (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:drop-inventory</span>))
</span><span style="display:block;width:100%;background-color:#dfdfdf">    (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">inventory-title</span> (<span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:show-inventory</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                            <span style="color:#b44">&#34;Press key next to item to use it, or Esc to cancel.&#34;</span>
</span><span style="display:block;width:100%;background-color:#dfdfdf">                            <span style="color:#b44">&#34;Press key next to item to drop it, or Esc to cancel.&#34;</span>)))
</span>      (<span style="color:#b8860b">inventory-menu</span> <span style="color:#b8860b">inventory-title</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>) <span style="color:#666">50</span> <span style="color:#b8860b">screen-width</span> <span style="color:#b8860b">screen-height</span>)))</code></pre></td></tr></table>
</div>
</div>

<p>Add a &ldquo;drop-item&rdquo; method to the inventory. This will remove the item from the
inventory, and set it&rsquo;s position equal to the players current position.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">(<span style="color:#a2f">defgeneric</span> <span style="color:#b8860b">drop-item</span> (<span style="color:#b8860b">inventory</span> <span style="color:#b8860b">item</span>))
(<span style="color:#a2f">defmethod</span> <span style="color:#b8860b">drop-item</span> ((<span style="color:#b8860b">inventory</span> <span style="color:#b8860b">inventory</span>) (<span style="color:#b8860b">item</span> <span style="color:#b8860b">entity</span>))
  (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">results</span> <span style="color:#800">nil</span>))
    (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">items</span>) <span style="color:#b8860b">inventory</span>
      (<span style="color:#a2f">with-slots</span> (<span style="color:#b8860b">x</span> <span style="color:#b8860b">y</span>) (<span style="color:#b8860b">component/owner</span> <span style="color:#b8860b">inventory</span>)
        (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">entity/x</span> <span style="color:#b8860b">item</span>) <span style="color:#b8860b">x</span>
              (<span style="color:#b8860b">entity/y</span> <span style="color:#b8860b">item</span>) <span style="color:#b8860b">y</span>
              <span style="color:#b8860b">items</span> (<span style="color:#00a000">remove-if</span> <span style="color:#00a000">#&#39;</span>(<span style="color:#a2f">lambda</span> (<span style="color:#b8860b">i</span>)
                                   (<span style="color:#00a000">eql</span> <span style="color:#b8860b">i</span> <span style="color:#b8860b">item</span>))
                               <span style="color:#b8860b">items</span>)
              <span style="color:#b8860b">results</span> (<span style="color:#00f">list</span> <span style="color:#b8860b">:item-dropped</span> <span style="color:#b8860b">item</span>
                            <span style="color:#b8860b">:message</span> (<span style="color:#00a000">format</span> <span style="color:#800">nil</span> <span style="color:#b44">&#34;You dropped the ~A&#34;</span> (<span style="color:#b8860b">entity/name</span> <span style="color:#b8860b">item</span>))
                            <span style="color:#b8860b">:message-color</span> (<span style="color:#b8860b">blt:yellow</span>)))))))</code></pre></div>
<p>Finally, update the &ldquo;game-tick&rdquo; to handle the results of dropping an item. It
will call the &ldquo;drop-item&rdquo; function, and switch the game state to the enemies turn.</p>

<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></span><span style="display:block;width:100%;background-color:#dfdfdf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lisp" data-lang="lisp">    (<span style="color:#a2f">when</span> (<span style="color:#a2f">and</span> <span style="color:#b8860b">inventory-index</span>
               (<span style="color:#00a000">not</span> (<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/previous-state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:player-dead</span>))
               (<span style="color:#00a000">&lt;</span> <span style="color:#b8860b">inventory-index</span> (<span style="color:#00a000">length</span> (<span style="color:#b8860b">inventory/items</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>)))))
      (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">item</span> (<span style="color:#00a000">nth</span> <span style="color:#b8860b">inventory-index</span> (<span style="color:#b8860b">inventory/items</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>)))))
        (<span style="color:#a2f">cond</span> ((<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:show-inventory</span>)
               (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">use-result</span> (<span style="color:#00a000">funcall</span> (<span style="color:#b8860b">item/use-function</span> (<span style="color:#b8860b">entity/item</span> <span style="color:#b8860b">item</span>)) (<span style="color:#b8860b">entity/item</span> <span style="color:#b8860b">item</span>) <span style="color:#b8860b">player</span>)))
                 (<span style="color:#a2f">setf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">use-result</span>)
                 (<span style="color:#a2f">when</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">use-result</span> <span style="color:#b8860b">:consumed</span>)
                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>)
                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">inventory/items</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>))
                         (<span style="color:#00a000">remove-if</span> <span style="color:#00a000">#&#39;</span>(<span style="color:#a2f">lambda</span> (<span style="color:#b8860b">i</span>)
                                        (<span style="color:#00a000">eql</span> <span style="color:#b8860b">i</span> <span style="color:#b8860b">item</span>))
                                    (<span style="color:#b8860b">inventory/items</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>)))))))
<span style="display:block;width:100%;background-color:#dfdfdf">              ((<span style="color:#00a000">eql</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:drop-inventory</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">               (<span style="color:#a2f;font-weight:bold">let</span> ((<span style="color:#b8860b">dropped-result</span> (<span style="color:#b8860b">drop-item</span> (<span style="color:#b8860b">entity/inventory</span> <span style="color:#b8860b">player</span>) <span style="color:#b8860b">item</span>)))
</span><span style="display:block;width:100%;background-color:#dfdfdf">                 (<span style="color:#a2f">setf</span> <span style="color:#b8860b">player-turn-results</span> <span style="color:#b8860b">dropped-result</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                 (<span style="color:#a2f">when</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">dropped-result</span> <span style="color:#b8860b">:item-dropped</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/state</span> <span style="color:#b8860b">game-state</span>) <span style="color:#b8860b">:enemy-turn</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                   (<span style="color:#a2f">setf</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>)
</span><span style="display:block;width:100%;background-color:#dfdfdf">                         (<span style="color:#00a000">append</span> (<span style="color:#b8860b">game-state/entities</span> <span style="color:#b8860b">game-state</span>) (<span style="color:#00f">list</span> (<span style="color:#00a000">getf</span> <span style="color:#b8860b">dropped-result</span> <span style="color:#b8860b">:item-dropped</span>))))))))))</span></code></pre></td></tr></table>
</div>
</div>

<p>Now you can run the game, and open the &ldquo;drop item&rdquo; inventory by pressing &rsquo;d&rsquo;.
Choosing an item from the inventory list will cause it to be removed from the
inventory, and placed back on the map.
<img src="/cl-rltut/drop-items.gif" alt="" /></p>

<h2 id="conclusion">Conclusion</h2>

<p>That&rsquo;s it for now. We added an item, with an inventory system. It&rsquo;s just a
healing potion now, but in the next tutorial we will look at adding a couple
more items.</p>

<p>You can find the current state of the code on <a href="https://github.com/nwforrer/cl-rltut/tree/part-6">Github</a>. The list of changes since
the previous tutorial can be found at
<a href="https://github.com/nwforrer/cl-rltut/compare/part-7-1...part-8">https://github.com/nwforrer/cl-rltut/compare/part-7-1...part-8</a>.</p>

<p>If you run into any issues, or have questions/feedback, please open an issue on this
blogs <a href="https://github.com/nwforrer/blog/issues">GitHub repository</a>.</p>

		</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = '';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div><a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148797548-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
